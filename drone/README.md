# Drone

This package implements the code required to fly a drone simulated in Gazebo.

## Running the drone

First, follow the
install, build and run instructions in the `scripts/readme.md` file.

Starting the drone can be done manually as follows:

```text
cd ~/drones_ws/
. ./install/setup.bash
build/drone/drone
```

## Personal notes

These are notes on how I got to the current solution.  I find that the warning
and error messages being produced when something goes wrong are worth
capturing.  They are often useful when you update a package or two and
everything breaks.

When working on your own, I find that writing down the problem also helps to
clarify what you are working on and what you have tried already.

### Missing a connection between my drone app and the MicroRTPS client

Add a listener to the drone class for some messages from the MicroRTPS client.
DONE. No change.

Is the target_system value important?  Corrected it to 1 to match my test setup.
No change.

The only nodes running are `/gazebo` and `/auto_pilot` so there is nothing to
send the messages to.  Proceses running are:

```text
gzserver --verbose --physics=ode --server-plugin libgazebo_ros_factory.so worlds/empty.world
gzclient --verbose
bin/px4 /tmp/px4/ROMFS/px4fmu_common -s /tmp/px4/ROMFS/px4fmu_common/init.d-posix/rcS -i 0
/usr/bin/python3 /opt/ros/eloquent/bin/_ros2_daemon --rmw-implementation rmw_fastrtps_cpp --ros-domain-id 0
```

The micrortps client is running - I used the px4 prompt to get the status, but
this clearly **does not** start a ROS node.  Looks like I need the px4_ros_com
package.

Added `px4_ros_com` build and install scripts.  Managed to get it to build and
run but it has many build warnings.  See other bugs for details.

Started like this:

```text
cd ~/drones_ws
build/px4_ros_com/micrortps_agent -t UDP -r 2020 -s 2019
```

Then tested this using a pre-built listener:

```text
cd ~/drones_ws
build/px4_ros_com/sensor_combined_listener
```

And I see a stream of info fly by on the terminal.

### Connect drone to px4_ros_com

`px4_ros_com` has a lot of topics but no services or actions.  The full list is:

```text
$ ros2 topic list
/AdcReport_PubSubTopic
/Airspeed_PubSubTopic
/BatteryStatus_PubSubTopic
/CameraCapture_PubSubTopic
/CameraTrigger_PubSubTopic
/CollisionConstraints_PubSubTopic
/CollisionReport_PubSubTopic
/Cpuload_PubSubTopic
/DebugArray_PubSubTopic
/DebugKeyValue_PubSubTopic
/DebugValue_PubSubTopic
/DebugVect_PubSubTopic
/DistanceSensor_PubSubTopic
/EstimatorStatus_PubSubTopic
/HomePosition_PubSubTopic
/IridiumsbdStatus_PubSubTopic
/ObstacleDistance_PubSubTopic
/OnboardComputerStatus_PubSubTopic
/OpticalFlow_PubSubTopic
/PositionSetpointTriplet_PubSubTopic
/PositionSetpoint_PubSubTopic
/RadioStatus_PubSubTopic
/SatelliteInfo_PubSubTopic
/SensorBaro_PubSubTopic
/SensorCombined_PubSubTopic
/SensorSelection_PubSubTopic
/Timesync_PubSubTopic
/TrajectoryWaypoint_PubSubTopic
/VehicleAttitude_PubSubTopic
/VehicleMocapOdometry_PubSubTopic
/VehicleOdometry_PubSubTopic
/VehicleTrajectoryWaypoint_PubSubTopic
/VehicleVisualOdometry_PubSubTopic
/VtolVehicleStatus_PubSubTopic
/WindEstimate_PubSubTopic
/clock
/parameter_events
/rosout
```

The list of nodes is even longer!

Getting info on one topic shows:

```text
$ ros2 topic info /BatteryStatus_PubSubTopic
Type: px4_msgs/msg/BatteryStatus
Publisher count: 1
Subscriber count: 0
```

px4 messages are used so I should be able to get the drone to listen to
the battery status messages.

Added subscriber using the string `BatteryStatus_PubSubTopic` and the battery
status messages can now be seen.

The drone and the px4 SITL drone are connected!!!!

### Get the drone to fly

Now that we have a connection, let's try to make it fly.  The commander
messages are in the file `px4_ros_com/templates/uorb_rtps_message_ids.yaml`,

```yaml
  - id: 89
    msg: VehicleCommand
  - id: 90
    msg: VehicleCommandAck
```

So we should just have to setup the current publisher correctly and it should
go.  There were no topics with commander in them from the `ros2 topic list`
command, so they must be hiding somewhere :-)

#### Finding the mising topics

Used grep to search for key words.  The VehicleCommand messages are being
processed and the cpp and hpp files are generated but for some reason, the
subscriber is not being started.  The subscribers are started in
by code in `px4_ros_com/src/micrortps_agent/RtpsTopics.cpp`  that is built from
`px4_ros_com/templates/RtpsTopics.cpp.em`.  The loop variable is `recv_topics`
so I need to find out what is in this list and how to get the VehicleCommand
into the list.

The file `px4_ros_com/cmake/GenerateMicroRTPSAgent.cmake` builds the code.  The
code is generated by `px4_ros_com/scripts/generate_microRTPS_bridge.py`.  The
trail leads back to the file
`px4_ros_com/scripts/px_generate_uorb_topic_files.py` that takes a command
line argument of `-f file_name`.  The file name is provided by ???

This command looks interesting.

```bash
   ${PYTHON_EXECUTABLE}
         ${CMAKE_CURRENT_SOURCE_DIR}/scripts/uorb_rtps_classifier.py
         --receive  # the msgs the client receives, are the messages
                     # the agent sends
         --alias    # retrieves alias topics as well
         --topic-msg-dir
         ${MSGS_DIR}
         --rtps-ids-file
         ${CMAKE_CURRENT_SOURCE_DIR}/templates/uorb_rtps_message_ids.yaml
```

Calling this manually shows this:

```bash
cd px4_ros_com
/usr/bin/python3 \
/home/andy/drones_ws/src/px4_ros_com/scripts/uorb_rtps_classifier.py \
--receive  --alias \
--topic-msg-dir /home/andy/drones_ws/src/px4_msgs \
--rtps-ids-file /home/andy/drones_ws/src/px4_ros_com/templates/uorb_rtps_message_ids.yaml
```

```text
CameraCapture, CameraTrigger, CollisionReport, DebugArray, DebugKeyValue, DebugValue, DebugVect, ObstacleDistance, OpticalFlow, PositionSetpoint, PositionSetpointTriplet, Timesync, TrajectoryWaypoint, VehicleTrajectoryWaypoint, OnboardComputerStatus alias VehicleMocapOdometry, VehicleVisualOdometry
```

This is repeated using the same command with different parameters for the send
and it generates:

```bash
cd px4_ros_com
/usr/bin/python3 \
/home/andy/drones_ws/src/px4_ros_com/scripts/uorb_rtps_classifier.py \
--send  --alias \
--topic-msg-dir /home/andy/drones_ws/src/px4_msgs \
--rtps-ids-file /home/andy/drones_ws/src/px4_ros_com/templates/uorb_rtps_message_ids.yaml
```

```text
AdcReport, Airspeed, BatteryStatus, Cpuload, DistanceSensor, EstimatorStatus, HomePosition, IridiumsbdStatus, RadioStatus, SatelliteInfo, SensorBaro, SensorCombined, SensorSelection, Timesync, VehicleAttitude, VehicleOdometry, VtolVehicleStatus, WindEstimate, CollisionConstraints
```

This looks like the total list output when starting.  So I need to fix this.
The `--receive` option should generate the `VehicleCommand` value so I can
focus on this.

Looking at the scripts and the `px4_ros_com/templates/uorb_rtps_message_ids.yaml`
file, I realised that the yaml file needed to be modified.

```yaml
  - id: 11
    msg: Cpuload
    send: true
  - id: 12
    msg: DebugArray
    receive: true
```

In the above example from the default file, the `CpuLoad` and the `DebugArray`
topics are generated by the scripts.  The values `send: true` and
`receive: true` are the things that the scripts look for in order to generate
the appropriate code.

I need a customised version of the YAML file that enables the features I want
and disables the fetures I don't.  Modified the build scripts to use the
`PX4/Firmware` version of the YAML file so that the PX4 instance and the
px4_ros_com instance stay in step when changes are made.  The changes are
stored on a project branch on fork of the PX4/Firmware repo.

I enabled the following messages:

```yaml
   - id: 89
     msg: VehicleCommand
     receive: true
   - id: 90
     msg: VehicleCommandAck
     send: true
   - id: 94
     msg: VehicleGpsPosition
     send: true
   - id: 95
     msg: VehicleLandDetected
     send: true
   - id: 102
     msg: VehicleStatus
    send: true
```

and then rebuilt the code.  The `Unexpected topic ID` messages are now handled
by the MicroRTPS Agent.

FIXME: There is a problem as make doesn't test for changes to the YAML file.
A workaround is to do the following:

```text
cd scripts/1804_eloquent_gazebo11/build
./clean_px4_uorb_yaml.bash
```

##### PX4/Firmware version of px4_ros_com

When I was searching for info on how `px4_ros_com` works, I reliased that there
was another copy of most of the `px4_ros_com` code in the `PX4/Firmware` repo.
This is because the uORB messages in the `PX4/Firmware` repo are the master
messages that generate the `px4_msgs` used by `px4_ros_com` by the TravisCI
build.  Git tags would be a great help here!

For the purposes of this project, I decided to build `px4_ros_com` as a
separate build step as I have more control.

### Not all callbacks working

Two callbacks were not being called:

* VehicleCommandAckCallback
* VehicleGpsPositionCallback

When the drone code connects to the topics advertised by the `px4_ros_com`
process, it prints out the topics that are matched:

```text
 - BatteryStatus publisher matched
 - VehicleStatus publisher matched
 - VehicleCommand subscriber matched
 - VehicleLandDetected publisher matched
 - VehicleCommandAck publisher matched
```

This shows that the VehicleCommandAckCallback was being matched so should be
working and that VehicleGpsPositionCallback was not being matched so would
not work.

#### VehicleGpsPositionCallback

The only topic not being matched that should be is the one used by
`VehicleGpsPositionCallback`.  Verified that the advertised topic
`VehicleGpsPosition_PubSubTopic` was being used by the drone (used
`ros2 topic list` and copy/pasted the `VehicleGpsPosition_PubSubTopic` into the
code.  No changes.)

So I need to verify that the code to handle the
`VehicleGpsPosition_PubSubTopic` was being created in the `px4_ros_com` code.
A quick grep showed that the code was being generated so it must be something
else.  I checked the code that creates the callback in the drone and you
can see the mistake below.

```diff
-  vehicle_gps_position_sub_= create_subscription<px4_msgs::msg::VehicleCommandAck>(
+  vehicle_gps_position_sub_= create_subscription<px4_msgs::msg::VehicleGpsPosition>(
           "VehicleGpsPosition_PubSubTopic", 10, std::bind(&AutoPilotPX4::VehicleGpsPositionCallback, this, std::placeholders::_1));
```

After a rebuild and test, the callback is now registered:

```text
 - VehicleStatus publisher matched
 - VehicleCommandAck publisher matched
 - VehicleLandDetected publisher matched
 - VehicleGpsPosition publisher matched
 - VehicleCommand subscriber matched
 - BatteryStatus publisher matched
```

The debug output shows correctly and the altitude is indeed 488.054 metres (
what I had guessed from the output).

#### VehicleCommandAckCallback

This callback was being registered with the `px4_ros_com` agent (it showed up
in the matched message).  So the ack is not being sent for some reason.

The first thing to check is that I am sending the command message correctly.
As there is no documentation on how the message should be used, time to dig
around in the code.

The code that seems to handle the VehicleCommand msg is in
`PX4/Firmware/src/modules/commander/Commander.cpp`.  For some reason, the
message has changed case and is `vehicle_command` in the Firmware repo.

Wrong! The `commander` module implements the command line interface used by
the PX4 shell.  It does show that each command is created inside an instance of
`uORB::PublicationQueued`.  So it appears that the PX4 messages are converted
to uORB messages that are then somehow sent to this file
`PX4/Firmware/src/lib/flight_tasks/FightTasks.cpp` and the function
`void FlightTasks::_updateCommand()` that seems to handle the
command messages and generate the acks.  There are no build options so the acks
must be generated at this level.

Added debug in Firmware and px4_ros_com.  printf() doesn't seen to work in PX4.
library code.  Can't find a way to print.

Used PX4 command prompt to show uORB message statistics (`uorb status`).  This
shows that the vehicle_command message never appears.

Tried a random thing!  Took off using the PX4 commander and then started the
drone process.  The drone flew off sideways!  So the commands are getting
through!  The run looks like this.

```text
pxh> commander takeoff
pxh> INFO  [commander] ARMED by Arm/Disarm component command
INFO  [logger] Start file log (type: full)
INFO  [logger] [logger] ./log/2020-07-29/10_59_13.ulg
INFO  [logger] Opened full log file: ./log/2020-07-29/10_59_13.ulg
INFO  [navigator] Using minimum takeoff altitude: 2.50 m
INFO  [commander] Takeoff detected
WARN  [commander] Failsafe enabled: no datalink
INFO  [commander] Failsafe mode activated
INFO  [navigator] RTL HOME activated
INFO  [navigator] RTL: landing at home position.
INFO  [navigator] RTL: climb to 498 m (10 m above destination)
INFO  [commander] Failsafe mode deactivated
WARN  [commander] Arming denied! Already armed
INFO  [commander] Landing at current position
WARN  [commander] Disarming denied! Not landed
INFO  [commander] Landing detected
INFO  [commander] DISARMED by Auto disarm initiated
INFO  [logger] closed logfile, bytes written: 1212314
```

The takeoff command causes the drone to take of to 2.5m above ground.  The
failsafe mode is then activated causing the drone to fly upwards to 10 metres
above the ground. During this ascent, I run drone.  At this pont failsafe mode is deactivated, the drone continues to ascend and flies sideways for a while,
then lands.  The GPS output from drone shows that there is a change in
position.

The flying sideways is caused by the drone attempting to fly towards the
latitude and longitude that I have given it 0.0, 0.0.  Need to fix this.

Something extra needs to be done to take control of the drone using
`px4_ros_com` as I can't get it to take off.  The PX4 commander does it right!

Made it take off, once!  The proof is here.  Nav state 17 is take off.

```text
andy@andy-Precision-7510 ~/drones_ws$ ./build/drone/drone
[DEBUG] [auto_pilot]: / target_system 0

[INFO] [Drone]: Run: started
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 90.986397%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455939, alt 488053
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: TakeOff: called: height 10.000000
[DEBUG] [auto_pilot]: TakeOff: flight_state_ 0
[DEBUG] [auto_pilot]: WaitForGPS: called
[DEBUG] [auto_pilot]: WaitForGPS: done
[DEBUG] [auto_pilot]: TakeOff: flight_state_ 2
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 90.930267%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455939, alt 488053
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 89.920853%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 88.287163%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977416, long 85455928, alt 489544
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 5, hil_state 0, failsafe 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 5, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 86.422638%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 5, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: Land: called
[DEBUG] [auto_pilot]: Land: flight_state_ 3
[DEBUG] [auto_pilot]: Land: flight_state_ 6
[DEBUG] [auto_pilot]: WaitUntilLanded: called
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 84.472992%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977415, long 85455925, alt 492854
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 82.491776%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977417, long 85455928, alt 494873
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 80.498795%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 78.501556%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977421, long 85455934, alt 492919
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 76.502655%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 74.503372%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455927, alt 491159
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 72.503807%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455926, alt 489671
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 70.504089%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 68.504333%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455930, alt 488246
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 66.504578%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 64.504913%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455930, alt 488056
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 62.505150%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: WaitUntilLanded: done
[DEBUG] [auto_pilot]: Land: flight_state_ 1
[DEBUG] [auto_pilot]: Arm: called: arm: 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455930, alt 488053
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 60.589123%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: Land: flight_state_ 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 59.653137%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455930, alt 488054
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 59.307194%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[INFO] [Drone]: Run: called
```https://mavlink.io/en/messages/common.html#mav_commands

Closed down simulation and retried and back to not flying.  I am definitely missing something.

```text
andy@andy-Precision-7510 ~/drones_ws$ ./build/drone/drone
[DEBUG] [auto_pilot]: / target_system 0

[INFO] [Drone]: Run: started
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 100.000000%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: TakeOff: called: height 10.000000
[DEBUG] [auto_pilot]: TakeOff: flight_state_ 0
[DEBUG] [auto_pilot]: WaitForGPS: called
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455939, alt 488054
[DEBUG] [auto_pilot]: WaitForGPS: done
[DEBUG] [auto_pilot]: TakeOff: flight_state_ 2
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 99.935913%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 98.909233%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455940, alt 488055
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 97.269775%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 95.402954%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455940, alt 488053
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: Land: called
[DEBUG] [auto_pilot]: Land: flight_state_ 3
[DEBUG] [auto_pilot]: Land: flight_state_ 6
[DEBUG] [auto_pilot]: WaitUntilLanded: called
[DEBUG] [auto_pilot]: WaitUntilLanded: done
[DEBUG] [auto_pilot]: Land: flight_state_ 1
[DEBUG] [auto_pilot]: Arm: called: arm: 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 93.536087%
[DEBUG] [auto_pilot]: Land: flight_state_ 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455939, alt 488055
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 92.618797%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 92.279816%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455939, alt 488054
[INFO] [Drone]: Run: called
andy@andy-Precision-7510 ~/drones_ws$ ./build/drone/drone
[DEBUG] [auto_pilot]: / target_system 0

[INFO] [Drone]: Run: started
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 92.083885%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455940, alt 488053
[DEBUG] [auto_pilot]: TakeOff: called: height 10.000000
[DEBUG] [auto_pilot]: TakeOff: flight_state_ 0
[DEBUG] [auto_pilot]: WaitForGPS: called
[DEBUG] [auto_pilot]: WaitForGPS: done
[DEBUG] [auto_pilot]: TakeOff: flight_state_ 2
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 92.032578%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455939, alt 488054
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 91.033981%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 89.404205%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455940, alt 488054
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 87.541389%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: Land: called
[DEBUG] [auto_pilot]: Land: flight_state_ 3
[DEBUG] [auto_pilot]: Land: flight_state_ 6
[DEBUG] [auto_pilot]: WaitUntilLanded: called
[DEBUG] [auto_pilot]: WaitUntilLanded: done
[DEBUG] [auto_pilot]: Land: flight_state_ 1
[DEBUG] [auto_pilot]: Arm: called: arm: 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 85.709473%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455939, alt 488054
[DEBUG] [auto_pilot]: Land: flight_state_ 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 84.846451%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455939, alt 488053
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 84.527397%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[INFO] [Drone]: Run: called
```

Eventually figured out where the parameters for each command message are defined:
https://mavlink.io/en/messages/common.html#mav_commands

The messages that I am sending appear to be handled in the Commander code
`PX4/Firmware/src/modules/commander/Commander.cpp` by the function:
`Commander::handle_command` (from the PX4 shell output for arm/disarm).

Found this example that uses MAVROS to do offboard control.
https://dev.px4.io/master/en/ros/mavros_offboard.html

Another example is:
https://github.com/intel-aero/sample-apps/tree/master/ros/src/aero_offboard_velocity
This is a bit more readable than the minimal example.  The general sequence
appears to be:

1. Arm.
2. Take off.
3. Fly about a bit.
4. Land.

Now to convert it from `mavros` to `px4_ros_com` messages and hope it works.

## Useful info

On the PX4 terminal, the command `uorb top` shows the rates of all the
publishers, e.g.

```text
update: 1s, num topics: 65
TOPIC NAME                         INST #SUB RATE #LOST #Q SIZE
sensor_accel                          0    4  249     0  8   48
sensor_gyro                           0    4  250     0  8   40
sensor_mag                            0    2   91     0  1   48
sensor_baro                           0    3   48     0  1   32
actuator_outputs                      0    5  250   687  1   80
ekf2_timestamps                       0    2  250     0  1   24
vehicle_attitude_groundtruth          0    1  250     0  1   48
vehicle_global_position_groundtruth   0    1  250     0  1   56
vehicle_local_position_groundtruth    0    1  250     0  1  152
battery_status                        0    9   83   461  1  112
vehicle_imu                           0    2  250     0  1   56
vehicle_imu_status                    0    5   10    14  1   56
vehicle_control_mode                  0    8    1     0  1   32
vehicle_status                        0   32    1     1  1   56
actuator_armed                        0    5    1     0  1   24
vehicle_status_flags                  0    1    1     0  1   40
sensor_combined                       0    5  250   481  1   48
sensor_preflight                      0    1  250     0  1   24
vehicle_acceleration                  0    1  250   201  1   32
vehicle_angular_acceleration          0    2  250     0  1   32
vehicle_angular_velocity              0    9  250  1437  1   32
vehicle_local_position                0   22  100  1692  1  152
position_setpoint_triplet             0    8   19    75  1  344
actuator_controls_0                   0    9  250   688  1   48
rate_ctrl_status                      0    1  250     0  1   24
multirotor_motor_limits               0    2  250     0  1   16
vehicle_attitude                      0   12  250  1851  1   48
vehicle_local_position_setpoint       0    9   50    89  1   80
vehicle_land_detected                 0   15    1     1  1   24
vehicle_gps_position                  0    7    2     1  1  104
vehicle_magnetometer                  0    4   91   124  1   24
telemetry_status                      0    2    2     0  3   48
vehicle_air_data                      0    7   48   159  1   40
vehicle_odometry                      0    3  100   165  1  256
estimator_sensor_bias                 0    5  100   142  1   56
estimator_status                      0    6  100   229  1  288
ekf_gps_drift                         0    1    2     0  1   24
estimator_innovations                 0    1  100     0  1  144
estimator_innovation_variances        0    1  100     0  1  144
estimator_innovation_test_ratios      0    1  100     0  1  144
vehicle_attitude_setpoint             0    5   50    89  1   64
vehicle_rates_setpoint                0    5  249   716  1   32
timesync                              0    1   11     1  1   32
vehicle_global_position               0    9  100   728  1   56
geofence_result                       0    1    4     0  1   16
trajectory_setpoint                   0    1   50     0  1   80
hover_thrust_estimate                 0    3   50     0  1   32
```

The ground truth publishers look useful.

### Set GPS initial position

Woodhouse moor N: 53.810217, E: -1.559740

export PX4_HOME_LAT=28.452386
export PX4_HOME_LON=-13.867138
export PX4_HOME_ALT=28.5
make px4_sitl gazebo

## Bugs

### Missing libpx4_msgs__rosidl_typesupport_fastrtps_cpp.so

```text
$  build/drone/drone
build/drone/drone: error while loading shared libraries: libpx4_msgs__rosidl_typesupport_fastrtps_cpp.so: cannot open shared object file: No such file or directory
```

Fixed by calling:

```text
. ./install/local_setup.bash
```

### Rebuild px4_ros_com

Ended up building `px4_ros_com` using colcon.  Change px4_ros_com.bash
to use `colcon build --merge-install` like the rest of the scripts.

### Fix px4_ros_com build warnings

```text
CMakeFiles/micrortps_agent.dir/build.make:353: warning: overriding recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/Timesync.cpp'
CMakeFiles/micrortps_agent.dir/build.make:182: warning: ignoring old recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/Timesync.cpp'
CMakeFiles/micrortps_agent.dir/build.make:356: warning: overriding recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/TimesyncPubSubTypes.cpp'
CMakeFiles/micrortps_agent.dir/build.make:185: warning: ignoring old recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/TimesyncPubSubTypes.cpp'
CMakeFiles/micrortps_agent.dir/build.make:359: warning: overriding recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/TimesyncPubSubTypes.h'
CMakeFiles/micrortps_agent.dir/build.make:188: warning: ignoring old recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/TimesyncPubSubTypes.h'
CMakeFiles/micrortps_agent.dir/build.make:353: warning: overriding recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/Timesync.cpp'
CMakeFiles/micrortps_agent.dir/build.make:182: warning: ignoring old recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/Timesync.cpp'
CMakeFiles/micrortps_agent.dir/build.make:356: warning: overriding recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/TimesyncPubSubTypes.cpp'
CMakeFiles/micrortps_agent.dir/build.make:185: warning: ignoring old recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/TimesyncPubSubTypes.cpp'
CMakeFiles/micrortps_agent.dir/build.make:359: warning: overriding recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/TimesyncPubSubTypes.h'
CMakeFiles/micrortps_agent.dir/build.make:188: warning: ignoring old recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/TimesyncPubSubTypes.h'
In file included from /home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/RtpsTopics.h:38:0,
                 from /home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/RtpsTopics.cpp:34:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h: In member function ‘uint64_t TimeSync::setMsgTimestamp(timesync_msg_t*, const uint64_t&)’:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h:170:114: warning: no return statement in function returning non-void [-Wreturn-type]
  inline uint64_t setMsgTimestamp(timesync_msg_t* msg, const uint64_t& timestamp) { msg->timestamp() = timestamp; }
                                                                                                                  ^
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h: In member function ‘uint8_t TimeSync::setMsgSysID(timesync_msg_t*, const uint8_t&)’:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h:171:99: warning: no return statement in function returning non-void [-Wreturn-type]
  inline uint8_t setMsgSysID(timesync_msg_t* msg, const uint8_t& sys_id) { msg->sys_id() = sys_id; }
                                                                                                   ^
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h: In member function ‘uint8_t TimeSync::setMsgSeq(timesync_msg_t*, const uint8_t&)’:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h:172:88: warning: no return statement in function returning non-void [-Wreturn-type]
  inline uint8_t setMsgSeq(timesync_msg_t* msg, const uint8_t& seq) { msg->seq() = seq; }
                                                                                        ^
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h: In member function ‘int64_t TimeSync::setMsgTC1(timesync_msg_t*, const int64_t&)’:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h:173:88: warning: no return statement in function returning non-void [-Wreturn-type]
  inline int64_t setMsgTC1(timesync_msg_t* msg, const int64_t& tc1) { msg->tc1() = tc1; }
                                                                                        ^
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h: In member function ‘int64_t TimeSync::setMsgTS1(timesync_msg_t*, const int64_t&)’:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h:174:88: warning: no return statement in function returning non-void [-Wreturn-type]
  inline int64_t setMsgTS1(timesync_msg_t* msg, const int64_t& ts1) { msg->ts1() = ts1; }
                                                                                        ^
In file included from /home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/RtpsTopics.cpp:34:0:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/RtpsTopics.h: In member function ‘uint64_t RtpsTopics::setMsgTimestamp(T*, const uint64_t&)’:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/RtpsTopics.h:175:104: warning: no return statement in function returning non-void [-Wreturn-type]
     inline uint64_t setMsgTimestamp(T* msg, const uint64_t& timestamp) { msg->timestamp() = timestamp; }
                                                                                                        ^
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/RtpsTopics.h: In member function ‘uint8_t RtpsTopics::setMsgSysID(T*, const uint8_t&)’:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/RtpsTopics.h:178:89: warning: no return statement in function returning non-void [-Wreturn-type]
     inline uint8_t setMsgSysID(T* msg, const uint8_t& sys_id) { msg->sys_id() = sys_id; }
                                                                                         ^
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/RtpsTopics.h: In member function ‘uint8_t RtpsTopics::setMsgSeq(T*, const uint8_t&)’:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/RtpsTopics.h:181:78: warning: no return statement in function returning non-void [-Wreturn-type]
     inline uint8_t setMsgSeq(T* msg, const uint8_t& seq) { msg->seq() = seq; }
                                                                              ^
In file included from /home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.cpp:42:0:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h: In member function ‘uint64_t TimeSync::setMsgTimestamp(timesync_msg_t*, const uint64_t&)’:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h:170:114: warning: no return statement in function returning non-void [-Wreturn-type]
  inline uint64_t setMsgTimestamp(timesync_msg_t* msg, const uint64_t& timestamp) { msg->timestamp() = timestamp; }
                                                                                                                  ^
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h: In member function ‘uint8_t TimeSync::setMsgSysID(timesync_msg_t*, const uint8_t&)’:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h:171:99: warning: no return statement in function returning non-void [-Wreturn-type]
  inline uint8_t setMsgSysID(timesync_msg_t* msg, const uint8_t& sys_id) { msg->sys_id() = sys_id; }
                                                                                                   ^
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h: In member function ‘uint8_t TimeSync::setMsgSeq(timesync_msg_t*, const uint8_t&)’:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h:172:88: warning: no return statement in function returning non-void [-Wreturn-type]
  inline uint8_t setMsgSeq(timesync_msg_t* msg, const uint8_t& seq) { msg->seq() = seq; }
                                                                                        ^
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h: In member function ‘int64_t TimeSync::setMsgTC1(timesync_msg_t*, const int64_t&)’:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h:173:88: warning: no return statement in function returning non-void [-Wreturn-type]
  inline int64_t setMsgTC1(timesync_msg_t* msg, const int64_t& tc1) { msg->tc1() = tc1; }
                                                                                        ^
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h: In member function ‘int64_t TimeSync::setMsgTS1(timesync_msg_t*, const int64_t&)’:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h:174:88: warning: no return statement in function returning non-void [-Wreturn-type]
  inline int64_t setMsgTS1(timesync_msg_t* msg, const int64_t& ts1) { msg->ts1() = ts1; }
                                                                                        ^
In file included from /home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_agent.cpp:52:0:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h: In member function ‘uint64_t TimeSync::setMsgTimestamp(timesync_msg_t*, const uint64_t&)’:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h:170:114: warning: no return statement in function returning non-void [-Wreturn-type]
  inline uint64_t setMsgTimestamp(timesync_msg_t* msg, const uint64_t& timestamp) { msg->timestamp() = timestamp; }
                                                                                                                  ^
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h: In member function ‘uint8_t TimeSync::setMsgSysID(timesync_msg_t*, const uint8_t&)’:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h:171:99: warning: no return statement in function returning non-void [-Wreturn-type]
  inline uint8_t setMsgSysID(timesync_msg_t* msg, const uint8_t& sys_id) { msg->sys_id() = sys_id; }
                                                                                                   ^
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h: In member function ‘uint8_t TimeSync::setMsgSeq(timesync_msg_t*, const uint8_t&)’:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h:172:88: warning: no return statement in function returning non-void [-Wreturn-type]
  inline uint8_t setMsgSeq(timesync_msg_t* msg, const uint8_t& seq) { msg->seq() = seq; }
                                                                                        ^
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h: In member function ‘int64_t TimeSync::setMsgTC1(timesync_msg_t*, const int64_t&)’:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h:173:88: warning: no return statement in function returning non-void [-Wreturn-type]
  inline int64_t setMsgTC1(timesync_msg_t* msg, const int64_t& tc1) { msg->tc1() = tc1; }
                                                                                        ^
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h: In member function ‘int64_t TimeSync::setMsgTS1(timesync_msg_t*, const int64_t&)’:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_timesync.h:174:88: warning: no return statement in function returning non-void [-Wreturn-type]
  inline int64_t setMsgTS1(timesync_msg_t* msg, const int64_t& ts1) { msg->ts1() = ts1; }
                                                                                        ^
In file included from /home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/microRTPS_agent.cpp:53:0:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/RtpsTopics.h: In member function ‘uint64_t RtpsTopics::setMsgTimestamp(T*, const uint64_t&)’:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/RtpsTopics.h:175:104: warning: no return statement in function returning non-void [-Wreturn-type]
     inline uint64_t setMsgTimestamp(T* msg, const uint64_t& timestamp) { msg->timestamp() = timestamp; }
                                                                                                        ^
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/RtpsTopics.h: In member function ‘uint8_t RtpsTopics::setMsgSysID(T*, const uint8_t&)’:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/RtpsTopics.h:178:89: warning: no return statement in function returning non-void [-Wreturn-type]
     inline uint8_t setMsgSysID(T* msg, const uint8_t& sys_id) { msg->sys_id() = sys_id; }
                                                                                         ^
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/RtpsTopics.h: In member function ‘uint8_t RtpsTopics::setMsgSeq(T*, const uint8_t&)’:
/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/RtpsTopics.h:181:78: warning: no return statement in function returning non-void [-Wreturn-type]
     inline uint8_t setMsgSeq(T* msg, const uint8_t& seq) { msg->seq() = seq; }
                                                                              ^
CMakeFiles/micrortps_agent.dir/build.make:353: warning: overriding recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/Timesync.cpp'
CMakeFiles/micrortps_agent.dir/build.make:182: warning: ignoring old recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/Timesync.cpp'
CMakeFiles/micrortps_agent.dir/build.make:356: warning: overriding recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/TimesyncPubSubTypes.cpp'
CMakeFiles/micrortps_agent.dir/build.make:185: warning: ignoring old recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/TimesyncPubSubTypes.cpp'
CMakeFiles/micrortps_agent.dir/build.make:359: warning: overriding recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/TimesyncPubSubTypes.h'
CMakeFiles/micrortps_agent.dir/build.make:188: warning: ignoring old recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/TimesyncPubSubTypes.h'
CMakeFiles/micrortps_agent.dir/build.make:353: warning: overriding recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/Timesync.cpp'
CMakeFiles/micrortps_agent.dir/build.make:182: warning: ignoring old recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/Timesync.cpp'
CMakeFiles/micrortps_agent.dir/build.make:356: warning: overriding recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/TimesyncPubSubTypes.cpp'
CMakeFiles/micrortps_agent.dir/build.make:185: warning: ignoring old recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/TimesyncPubSubTypes.cpp'
CMakeFiles/micrortps_agent.dir/build.make:359: warning: overriding recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/TimesyncPubSubTypes.h'
CMakeFiles/micrortps_agent.dir/build.make:188: warning: ignoring old recipe for target '/home/andy/drones_ws/src/px4_ros_com/src/micrortps_agent/TimesyncPubSubTypes.h'
---
Finished <<< px4_ros_com [5.93s]

```

Merged upstream fix for incorrect return types.

Created patch for the TimeSync overriding recipe problem (duplications in CMake)

### Fix px4_ros_com run time warnings

Steady stream of messages like this.  Probably a message mismatch.

```text
RTTI too high for timesync: 38ms
Offset not updated
Unexpected topic ID to publish
Unexpected topic ID to publish
Unexpected topic ID to publish
Unexpected topic ID to publish
...
```

Added debugging.  Topic IDs in question are 102 and 95.

Created patch for this.

### Fix px4_ros_com segfault on exit

Ctrl+c on running `px4_ros_com` instance causes seg fault.  If it is anything
like when I have seen it probably not causing thngs to shutdown correctly.

```text
^CInterrupt signal (2) received.
Closed sender socket!
Closed receiver socket!
Read fail 9
Segmentation fault (core dumped)
```

See also: https://github.com/PX4/px4_ros_com/issues/46

### Fix manual_start.bash

Need a proper solution as the PX4 directory needs to be created.  Currently only works using the gazebo-Learning version.

## Successful run

There was one successful run in amongst my numerous attempts.  There seems to
be a small window where I can get it to work, but I'm not sure what it is.

Added pre-flight checks and extra message (VehicleControlMode).
HERE!!! Add the message to Firme ware et al.

```text
ndy@andy-Precision-7510 ~/drones_ws$ ./build/drone/drone
[DEBUG] [auto_pilot]: / target_system 0

[INFO] [Drone]: Run: started
[DEBUG] [auto_pilot]: TakeOff: called: height 10.000000
[DEBUG] [auto_pilot]: WaitForGPS: called
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 83.304070%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455939, alt 488054
[DEBUG] [auto_pilot]: WaitForGPS: done
[DEBUG] [auto_pilot]: SendArmDisarm: called: arm: 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 83.304070%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455940, alt 488053
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 83.304070%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 83.304070%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455940, alt 488054
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 83.304070%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 83.304070%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455940, alt 488053
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 83.304070%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455939, alt 488054
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 83.304070%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 83.304070%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455939, alt 488053
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 83.304070%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 83.304070%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455939, alt 488054
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 83.304070%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455939, alt 488054
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 83.304070%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 83.304070%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455939, alt 488055
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 83.304070%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 83.304070%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455940, alt 488055
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 83.304070%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
^C[INFO] [rclcpp]: signal_handler(signal_value=2)
^Z
[1]+  Stopped                 ./build/drone/drone
andy@andy-Precision-7510 ~/drones_ws$ killall -9 drone
[1]+  Killed                  ./build/drone/drone
andy@andy-Precision-7510 ~/drones_ws$ colcon build --merge-install --packages-select drone
Starting >>> drone
Finished <<< drone [8.82s]

Summary: 1 package finished [9.02s]
andy@andy-Precision-7510 ~/drones_ws$ ./build/drone/drone
[DEBUG] [auto_pilot]: / target_system 0

[INFO] [Drone]: Run: started
[INFO] [auto_pilot]: TakeOff: called: height 10.000000
[DEBUG] [auto_pilot]: WaitForGPS: called
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 83.304070%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455940, alt 488053
[DEBUG] [auto_pilot]: WaitForGPS: done
[DEBUG] [auto_pilot]: SendArmDisarm: called: arm: 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[INFO] [auto_pilot]: TakeOff: Armed
[DEBUG] [auto_pilot]: SendTakeoff: taking off
[DEBUG] [auto_pilot]: SendTakeoff: off the ground
[INFO] [auto_pilot]: TakeOff: Taking off
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[INFO] [auto_pilot]: Land: called.
[DEBUG] [auto_pilot]: SendLand: called
[DEBUG] [auto_pilot]: SendLand: landing
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 82.767632%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[INFO] [auto_pilot]: SendLand: Landed.
[INFO] [Drone]: Run: fail
andy@andy-Precision-7510 ~/drones_ws$ colcon build --merge-install --packages-select drone
Starting >>> drone
Finished <<< drone [8.80s]

Summary: 1 package finished [9.00s]
andy@andy-Precision-7510 ~/drones_ws$ ./build/drone/drone
[DEBUG] [auto_pilot]: / target_system 0

[INFO] [Drone]: Run: started
[INFO] [auto_pilot]: TakeOff: called: height 10.000000
[DEBUG] [auto_pilot]: WaitForGPS: called
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 66.649292%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455940, alt 488054
[DEBUG] [auto_pilot]: WaitForGPS: done
[DEBUG] [auto_pilot]: SendArmDisarm: called: arm: 1
[DEBUG] [auto_pilot]: SendVehicleCommand: command 400
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[INFO] [auto_pilot]: TakeOff: Armed
[DEBUG] [auto_pilot]: SendVehicleCommand: command 22
[DEBUG] [auto_pilot]: SendTakeoff: taking off
[DEBUG] [auto_pilot]: SendTakeoff: off the ground
[INFO] [auto_pilot]: TakeOff: Taking off
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[INFO] [auto_pilot]: Land: called.
[DEBUG] [auto_pilot]: SendLand: called
[DEBUG] [auto_pilot]: SendVehicleCommand: command 21
[DEBUG] [auto_pilot]: SendLand: landing
[INFO] [auto_pilot]: SendLand: Landed.
[INFO] [Drone]: Run: fail
andy@andy-Precision-7510 ~/drones_ws$ ./build/drone/drone
[DEBUG] [auto_pilot]: / target_system 0

[INFO] [Drone]: Run: started
[INFO] [auto_pilot]: TakeOff: called: height 10.000000
[DEBUG] [auto_pilot]: WaitForGPS: called
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455940, alt 488053
[DEBUG] [auto_pilot]: WaitForGPS: done
[DEBUG] [auto_pilot]: SendArmDisarm: called: arm: 1
[DEBUG] [auto_pilot]: SendVehicleCommand: command 400
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[INFO] [auto_pilot]: TakeOff: Armed
[DEBUG] [auto_pilot]: SendVehicleCommand: command 22
[DEBUG] [auto_pilot]: SendTakeoff: taking off
[DEBUG] [auto_pilot]: SendTakeoff: off the ground
[INFO] [auto_pilot]: TakeOff: Taking off
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[INFO] [auto_pilot]: Land: called.
[DEBUG] [auto_pilot]: SendLand: called
[DEBUG] [auto_pilot]: SendVehicleCommand: command 21
[DEBUG] [auto_pilot]: SendLand: landing
[INFO] [auto_pilot]: SendLand: Landed.
[INFO] [Drone]: Run: fail
andy@andy-Precision-7510 ~/drones_ws$ colcon build --merge-install --packages-select drone
Starting >>> drone
Finished <<< drone [8.83s]

Summary: 1 package finished [9.03s]
andy@andy-Precision-7510 ~/drones_ws$ ./build/drone/drone
[DEBUG] [auto_pilot]: / target_system 0

[INFO] [Drone]: Run: started
[INFO] [auto_pilot]: TakeOff: called: height 10.000000
[DEBUG] [auto_pilot]: WaitForGPS: called
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455940, alt 488053
[DEBUG] [auto_pilot]: WaitForGPS: done
[DEBUG] [auto_pilot]: SendArmDisarm: called: arm: 1
[DEBUG] [auto_pilot]: SendVehicleCommand: command 400
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[INFO] [auto_pilot]: TakeOff: Armed
[DEBUG] [auto_pilot]: SendTakeoff: taking off
[DEBUG] [auto_pilot]: SendVehicleCommand: command 22
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455939, alt 488054
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455939, alt 488054
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[ERROR] [auto_pilot]: SendTakeoff: Still on the ground!
[INFO] [Drone]: Run: fail
andy@andy-Precision-7510 ~/drones_ws$ colcon build --merge-install --packages-select drone
Starting >>> drone
--- stderr: drone
/home/andy/drones_ws/src/drone/src/auto_pilot_px4.cpp: In member function ‘virtual int AutoPilotPX4::Land()’:
/home/andy/drones_ws/src/drone/src/auto_pilot_px4.cpp:109:25: error: void value not ignored as it ought to be
   int result = SendLand();
                         ^
make[2]: *** [CMakeFiles/drone.dir/src/auto_pilot_px4.cpp.o] Error 1
make[1]: *** [CMakeFiles/drone.dir/all] Error 2
make: *** [all] Error 2
---
Failed   <<< drone [4.36s, exited with code 2]

Summary: 0 packages finished [4.56s]
  1 package failed: drone
  1 package had stderr output: drone
andy@andy-Precision-7510 ~/drones_ws$ colcon build --merge-install --packages-select drone
Starting >>> drone
Finished <<< drone [8.75s]

Summary: 1 package finished [8.94s]
andy@andy-Precision-7510 ~/drones_ws$ ./build/drone/drone
[DEBUG] [auto_pilot]: / target_system 0

[INFO] [Drone]: Run: started
[INFO] [auto_pilot]: TakeOff: called: height 10.000000
[DEBUG] [auto_pilot]: WaitForGPS: called
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455940, alt 488053
[DEBUG] [auto_pilot]: WaitForGPS: done
[DEBUG] [auto_pilot]: SendArmDisarm: called: arm: 1
[DEBUG] [auto_pilot]: SendVehicleCommand: command 400
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[INFO] [auto_pilot]: TakeOff: Armed
[DEBUG] [auto_pilot]: SendTakeoff: taking off
[DEBUG] [auto_pilot]: SendVehicleCommand: command 22
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455940, alt 488053
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455940, alt 488054
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[INFO] [auto_pilot]: WaitUntilLanded: TIMEOUT!
[INFO] [Drone]: Run: fail
andy@andy-Precision-7510 ~/drones_ws$ colcon build --merge-install --packages-select drone
Starting >>> drone
--- stderr: drone
/home/andy/drones_ws/src/drone/src/auto_pilot_px4.cpp: In member function ‘virtual int AutoPilotPX4::TakeOff(float)’:
/home/andy/drones_ws/src/drone/src/auto_pilot_px4.cpp:85:7: error: redeclaration of ‘int result’
   int result = WaitForGPS();
       ^~~~~~
/home/andy/drones_ws/src/drone/src/auto_pilot_px4.cpp:80:7: note: ‘int result’ previously declared here
   int result = 0;
       ^~~~~~
make[2]: *** [CMakeFiles/drone.dir/src/auto_pilot_px4.cpp.o] Error 1
make[1]: *** [CMakeFiles/drone.dir/all] Error 2
make: *** [all] Error 2
---
Failed   <<< drone [4.32s, exited with code 2]

Summary: 0 packages finished [4.52s]
  1 package failed: drone
  1 package had stderr output: drone
andy@andy-Precision-7510 ~/drones_ws$ colcon build --merge-install --packages-select drone
Starting >>> drone
Finished <<< drone [8.84s]

Summary: 1 package finished [9.04s]
andy@andy-Precision-7510 ~/drones_ws$ ./build/drone/drone
[DEBUG] [auto_pilot]: / target_system 0

[INFO] [Drone]: Run: started
[INFO] [auto_pilot]: TakeOff: called: height 10.000000
[DEBUG] [auto_pilot]: WaitForGPS: called
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455940, alt 488054
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[INFO] [Drone]: Run: fail
andy@andy-Precision-7510 ~/drones_ws$ colcon build --merge-install --packages-select drone
Starting >>> drone
Finished <<< drone [8.85s]

Summary: 1 package finished [9.05s]
andy@andy-Precision-7510 ~/drones_ws$ ./build/drone/drone
[DEBUG] [auto_pilot]: / target_system 0

[INFO] [Drone]: Run: started
[INFO] [auto_pilot]: TakeOff: called: height 10.000000
[DEBUG] [auto_pilot]: WaitForGPS: called
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455940, alt 488054
[DEBUG] [auto_pilot]: WaitForGPS: GPS valid
[INFO] [Drone]: Run: fail
andy@andy-Precision-7510 ~/drones_ws$ colcon build --merge-install --packages-select drone
Starting >>> drone
Finished <<< drone [8.84s]

Summary: 1 package finished [9.04s]
andy@andy-Precision-7510 ~/drones_ws$ ./build/drone/drone
[DEBUG] [auto_pilot]: / target_system 0

[INFO] [Drone]: Run: started
[INFO] [auto_pilot]: TakeOff: called: height 10.000000
[DEBUG] [auto_pilot]: WaitForGPS: called
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455940, alt 488053
[DEBUG] [auto_pilot]: WaitForGPS: GPS valid
[DEBUG] [auto_pilot]: SendArmDisarm: called: arm: 1
[DEBUG] [auto_pilot]: SendVehicleCommand: command 400
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[INFO] [auto_pilot]: TakeOff: Armed
[DEBUG] [auto_pilot]: SendTakeoff: taking off
[DEBUG] [auto_pilot]: SendVehicleCommand: command 22
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455939, alt 488053
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455939, alt 488053
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[ERROR] [auto_pilot]: WaitUntilLanded: TIMEOUT!
[INFO] [Drone]: Run: fail
andy@andy-Precision-7510 ~/drones_ws$ colcon build --merge-install --packages-select drone
Starting >>> drone
Finished <<< drone [8.86s]

Summary: 1 package finished [9.05s]
andy@andy-Precision-7510 ~/drones_ws$ ./build/drone/drone
[DEBUG] [auto_pilot]: / target_system 0

[INFO] [Drone]: Run: started
[INFO] [auto_pilot]: TakeOff: called: height 10.000000
[DEBUG] [auto_pilot]: WaitForGPS: called
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455940, alt 488054
[DEBUG] [auto_pilot]: WaitForGPS: GPS valid
[DEBUG] [auto_pilot]: SendTakeoff: taking off
[DEBUG] [auto_pilot]: SendVehicleCommand: command 22
[DEBUG] [auto_pilot]: SendArmDisarm: called: arm: 1
[DEBUG] [auto_pilot]: SendVehicleCommand: command 400
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[INFO] [auto_pilot]: TakeOff: Armed
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: WaitUntilLanded: Off the ground
[INFO] [auto_pilot]: TakeOff: Taking off
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455938, alt 488215
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[INFO] [auto_pilot]: Land: called.
[DEBUG] [auto_pilot]: SendLand: called
[DEBUG] [auto_pilot]: SendVehicleCommand: command 21
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977418, long 85455926, alt 489242
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977421, long 85455927, alt 488055
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[ERROR] [auto_pilot]: WaitUntilLanded: TIMEOUT!
[INFO] [Drone]: Run: fail
andy@andy-Precision-7510 ~/drones_ws$ colcon build --merge-install --packages-select drone
Starting >>> drone
Finished <<< drone [8.98s]

Summary: 1 package finished [9.18s]
andy@andy-Precision-7510 ~/drones_ws$ ./build/drone/drone
[DEBUG] [auto_pilot]: / target_system 0

[INFO] [Drone]: Run: started
[INFO] [auto_pilot]: TakeOff: called: height 10.000000
[DEBUG] [auto_pilot]: WaitForGPS: called
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977421, long 85455927, alt 488054
[DEBUG] [auto_pilot]: WaitForGPS: GPS valid
[DEBUG] [auto_pilot]: SendTakeoff: taking off
[DEBUG] [auto_pilot]: SendVehicleCommand: command 22
[DEBUG] [auto_pilot]: SendArmDisarm: called: arm: 1
[DEBUG] [auto_pilot]: SendVehicleCommand: command 400
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[INFO] [auto_pilot]: TakeOff: Armed
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977421, long 85455927, alt 488054
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455927, alt 488055
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455927, alt 488054
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977421, long 85455927, alt 488054
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[ERROR] [auto_pilot]: WaitUntilLanded: TIMEOUT!
[INFO] [Drone]: Run: fail
andy@andy-Precision-7510 ~/drones_ws$ colcon build --merge-install --packages-select drone
Starting >>> drone
Finished <<< drone [9.08s]

Summary: 1 package finished [9.28s]
andy@andy-Precision-7510 ~/drones_ws$ ./build/drone/drone
[DEBUG] [auto_pilot]: / target_system 0

[INFO] [Drone]: Run: started
[DEBUG] [auto_pilot]: WaitForGPS: called
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977421, long 85455927, alt 488055
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: WaitForGPS: GPS valid
[DEBUG] [auto_pilot]: WaitForVehicleStatus: called
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: WaitForVehicleStatus: Vehicle status valid
[INFO] [auto_pilot]: TakeOff: called: height 10.000000
[DEBUG] [auto_pilot]: SendTakeoff: taking off
[DEBUG] [auto_pilot]: SendVehicleCommand: command 22
[DEBUG] [auto_pilot]: SendArmDisarm: called: arm: 1
[DEBUG] [auto_pilot]: SendVehicleCommand: command 400
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[INFO] [auto_pilot]: TakeOff: Armed
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455927, alt 488055
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977421, long 85455927, alt 488054
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455927, alt 488054
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455927, alt 488055
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[ERROR] [auto_pilot]: WaitUntilLanded: TIMEOUT!
[INFO] [Drone]: Run: fail

```

PX4 output

```text
INFO  [commander] ARMED by Arm/Disarm component command
INFO  [logger] Start file log (type: full)
INFO  [logger] [logger] ./log/2020-07-31/08_33_32.ulg
INFO  [logger] Opened full log file: ./log/2020-07-31/08_33_32.ulg
INFO  [commander] DISARMED by Auto disarm initiated
INFO  [logger] closed logfile, bytes written: 601631

INFO  [commander] ARMED by Arm/Disarm component command
INFO  [logger] Start file log (type: full)
INFO  [navigator] Using minimum takeoff altitude: 2.50 m
INFO  [logger] [logger] ./log/2020-07-31/08_48_36.ulg
INFO  [logger] Opened full log file: ./log/2020-07-31/08_48_36.ulg
INFO  [commander] DISARMED by Auto disarm initiated
INFO  [logger] closed logfile, bytes written: 584345

INFO  [commander] ARMED by Arm/Disarm component command
INFO  [navigator] Using minimum takeoff altitude: 2.50 m
INFO  [logger] Start file log (type: full)
INFO  [logger] [logger] ./log/2020-07-31/08_57_28.ulg
INFO  [logger] Opened full log file: ./log/2020-07-31/08_57_28.ulg
INFO  [commander] DISARMED by Auto disarm initiated
INFO  [logger] closed logfile, bytes written: 594012

##### This one flew!!!

INFO  [commander] ARMED by Arm/Disarm component command
INFO  [navigator] Using minimum takeoff altitude: 2.50 m
INFO  [logger] Start file log (type: full)
INFO  [logger] [logger] ./log/2020-07-31/09_11_43.ulg
INFO  [logger] Opened full log file: ./log/2020-07-31/09_11_43.ulg
INFO  [commander] Takeoff detected
INFO  [commander] Landing at current position
INFO  [commander] Landing detected
INFO  [commander] DISARMED by Auto disarm initiated
INFO  [logger] closed logfile, bytes written: 684086

INFO  [commander] ARMED by Arm/Disarm component command
INFO  [logger] Start file log (type: full)
INFO  [logger] [logger] ./log/2020-07-31/09_13_19.ulg
INFO  [logger] Opened full log file: ./log/2020-07-31/09_13_19.ulg
INFO  [commander] DISARMED by Auto disarm initiated
INFO  [logger] closed logfile, bytes written: 617552

INFO  [commander] ARMED by Arm/Disarm component command
INFO  [logger] Start file log (type: full)
INFO  [logger] [logger] ./log/2020-07-31/09_49_59.ulg
INFO  [logger] Opened full log file: ./log/2020-07-31/09_49_59.ulg
INFO  [commander] DISARMED by Auto disarm initiated
INFO  [logger] closed logfile, bytes written: 611327

```

I have a method of making it take off and land under my control but it involves
reordering the commands I send by rebuilding.  The output below shows the first ARM, TAKEOFF and the second run uses TAKEOFF, ARM.
run using ARM, TAKEOFF and the second run uses TAKEOFF, ARM.

```text
andy@andy-Precision-7510 ~/drones_ws$ ./build/drone/drone
[DEBUG] [auto_pilot]: / target_system 0

[INFO] [Drone]: Run: started
[DEBUG] [auto_pilot]: WaitForGPS: called
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977412, long 85455935, alt 488055
[DEBUG] [auto_pilot]: WaitForGPS: GPS available
[DEBUG] [auto_pilot]: WaitForVehicleStatus: called
[DEBUG] [auto_pilot]: WaitForVehicleStatus: Vehicle status available
[INFO] [Drone]: Run: Pre-flight checks OK
[INFO] [auto_pilot]: TakeOff: called: height 10.000000
[DEBUG] [auto_pilot]: SendArmDisarm: called: arm: 1
[DEBUG] [auto_pilot]: SendVehicleCommand: command 400
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[INFO] [auto_pilot]: TakeOff: Armed
[DEBUG] [auto_pilot]: SendTakeoff: taking off
[DEBUG] [auto_pilot]: SendVehicleCommand: command 22
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977412, long 85455935, alt 488054
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977412, long 85455935, alt 488055
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977412, long 85455935, alt 488055
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977412, long 85455935, alt 488053
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_hicleCommand: command 22
[DEBUG] [auto_pilot]: SendArmDisarm: called: arm: 1
[DEBUG] [auto_pilot]: SendVehicleCommand: command 400state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[ERROR] [auto_pilot]: WaitForLanded: TIMEOUT!
[INFO] [Drone]: Run: fail
andy@andy-Precision-7510 ~/drones_ws$ colcon build --merge-install --packages-select drone
Starting >>> drone
Finished <<< drone [1.03s]

Summary: 1 package finished [1.23s]
andy@andy-Precision-7510 ~/drones_ws$ ./build/drone/drone
[DEBUG] [auto_pilot]: / target_system 0

[INFO] [Drone]: Run: started
[DEBUG] [auto_pilot]: WaitForGPS: called
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977412, long 85455935, alt 488055
[DEBUG] [auto_pilot]: WaitForGPS: GPS available
[DEBUG] [auto_pilot]: WaitForVehicleStatus: called
[DEBUG] [auto_pilot]: WaitForVehicleStatus: Vehicle status available
[INFO] [Drone]: Run: Pre-flight checks OK
[INFO] [auto_pilot]: TakeOff: called: height 10.000000
[DEBUG] [auto_pilot]: SendTakeoff: taking off
[DEBUG] [auto_pilot]: SendVehicleCommand: command 22
[DEBUG] [auto_pilot]: SendArmDisarm: called: arm: 1
[DEBUG] [auto_pilot]: SendVehicleCommand: command 400
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[INFO] [auto_pilot]: TakeOff: Armed
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: WaitForLanded: Off the ground
[INFO] [auto_pilot]: TakeOff: Taking off
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977412, long 85455934, alt 488125
[INFO] [auto_pilot]: Land: called.
[DEBUG] [auto_pilot]: SendLand: called
[DEBUG] [auto_pilot]: SendVehicleCommand: command 21
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977408, long 85455919, alt 489257
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977411, long 85455929, alt 488058
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977411, long 85455929, alt 488053
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: WaitForLanded: Landed
[DEBUG] [auto_pilot]: SendArmDisarm: called: arm: 0
[DEBUG] [auto_pilot]: SendVehicleCommand: command 400
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[INFO] [auto_pilot]: Land: landed.
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977411, long 85455929, alt 488054
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 50.000286%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[INFO] [Drone]: Run: success
```

The PX4 output shows:

```text
INFO  [commander] ARMED by Arm/Disarm component command
INFO  [logger] Start file log (type: full)
INFO  [logger] [logger] ./log/2020-07-31/11_26_27.ulg
INFO  [logger] Opened full log file: ./log/2020-07-31/11_26_27.ulg
INFO  [commander] DISARMED by Auto disarm initiated
INFO  [logger] closed logfile, bytes written: 599119

INFO  [commander] ARMED by Arm/Disarm component command
INFO  [navigator] Using minimum takeoff altitude: 2.50 m
INFO  [logger] Start file log (type: full)
INFO  [logger] [logger] ./log/2020-07-31/11_27_15.ulg
INFO  [logger] Opened full log file: ./log/2020-07-31/11_27_15.ulg
INFO  [commander] Takeoff detected
INFO  [commander] Landing at current position
INFO  [commander] Landing detected
INFO  [commander] DISARMED by Arm/Disarm component command
INFO  [logger] closed logfile, bytes written: 564188
```

The sequence sent from both runs was:  ARM, TAKEOFF, TAKEOFF, ARM.

Trying the following sequence: ARM, TAKEOFF, TAKEOFF.  No good.

Trying a decision based on the starting state.  Works every other time.

Trying to understand what is going on better.  Added 2s delay between
`arm` and `takeoff`. Reliable every other time take off.

The 3 runs below catpure this from a fresh start up. The first run is as
expected, priming the PX4 for next time take off.  The problem is that the
disarm is never set by the drone so the disarm has to happen automatically.
I think this is why the PX4 never arms in the second run although the reason
for the lack of state change is not visible in the output.  The third run
results in a successful take off.

```text
andy@andy-Precision-7510 ~/drones_ws$ ./build/drone/drone
[DEBUG] [auto_pilot]: / target_system 0

[INFO] [Drone]: Run: started
[DEBUG] [auto_pilot]: WaitForGPS: called
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 100.000000%
[DEBUG] [auto_pilot]: WaitForGPS: wait_count 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455939, alt 488053
[DEBUG] [auto_pilot]: WaitForGPS: wait_count 2
[DEBUG] [auto_pilot]: WaitForGPS: GPS available
[DEBUG] [auto_pilot]: WaitForVehicleStatus: called
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: WaitForVehicleStatus: Vehicle status available
[INFO] [Drone]: Run: Pre-flight checks OK
[INFO] [auto_pilot]: TakeOff: called: height 10.000000
[DEBUG] [auto_pilot]: SendArm: called: arm: 1
[DEBUG] [auto_pilot]: SendVehicleCommand: command 400
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: SendArm: wait_count 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 99.603508%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 4, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455940, alt 488053
[DEBUG] [auto_pilot]: SendTakeoff: taking off
[DEBUG] [auto_pilot]: SendVehicleCommand: command 22
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 98.231888%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 96.464729%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455939, alt 488054
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 94.550705%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 92.582558%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455940, alt 488054
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 90.594528%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455940, alt 488053
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 88.599205%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 86.601067%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455940, alt 488054
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 84.725906%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[ERROR] [auto_pilot]: WaitForLanded: TIMEOUT!
[INFO] [Drone]: Run: fail
andy@andy-Precision-7510 ~/drones_ws$ ./build/drone/drone
[DEBUG] [auto_pilot]: / target_system 0

[INFO] [Drone]: Run: started
[DEBUG] [auto_pilot]: WaitForGPS: called
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 83.360001%
[DEBUG] [auto_pilot]: WaitForGPS: wait_count 1
[DEBUG] [auto_pilot]: WaitForGPS: wait_count 2
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455939, alt 488054
[DEBUG] [auto_pilot]: WaitForGPS: wait_count 3
[DEBUG] [auto_pilot]: WaitForGPS: GPS available
[DEBUG] [auto_pilot]: WaitForVehicleStatus: called
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: WaitForVehicleStatus: Vehicle status available
[INFO] [Drone]: Run: Pre-flight checks OK
[INFO] [auto_pilot]: TakeOff: called: height 10.000000
[DEBUG] [auto_pilot]: SendArm: called: arm: 1
[DEBUG] [auto_pilot]: SendVehicleCommand: command 400
[DEBUG] [auto_pilot]: SendArm: wait_count 1
[DEBUG] [auto_pilot]: SendArm: wait_count 2
[DEBUG] [auto_pilot]: SendArm: wait_count 3
[DEBUG] [auto_pilot]: SendArm: wait_count 4
[DEBUG] [auto_pilot]: SendArm: wait_count 5
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: SendArm: wait_count 6
[DEBUG] [auto_pilot]: SendArm: wait_count 7
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 83.349037%
[DEBUG] [auto_pilot]: SendArm: wait_count 8
[DEBUG] [auto_pilot]: SendArm: wait_count 9
[DEBUG] [auto_pilot]: SendArm: wait_count 10
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: SendArm: wait_count 11
[DEBUG] [auto_pilot]: SendArm: wait_count 12
[DEBUG] [auto_pilot]: SendArm: wait_count 13
[DEBUG] [auto_pilot]: SendArm: wait_count 14
[DEBUG] [auto_pilot]: SendArm: wait_count 15
[DEBUG] [auto_pilot]: SendArm: wait_count 16
[DEBUG] [auto_pilot]: SendArm: wait_count 17
[DEBUG] [auto_pilot]: SendArm: wait_count 18
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: SendArm: wait_count 19
[DEBUG] [auto_pilot]: SendArm: wait_count 20
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455939, alt 488054
[DEBUG] [auto_pilot]: SendArm: wait_count 21
[ERROR] [auto_pilot]: TakeOff: Arming failed
[INFO] [Drone]: Run: fail
andy@andy-Precision-7510 ~/drones_ws$ ./build/drone/drone
[DEBUG] [auto_pilot]: / target_system 0

[INFO] [Drone]: Run: started
[DEBUG] [auto_pilot]: WaitForGPS: called
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 83.344887%
[DEBUG] [auto_pilot]: WaitForGPS: wait_count 1
[DEBUG] [auto_pilot]: WaitForGPS: wait_count 2
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977420, long 85455939, alt 488054
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: WaitForGPS: wait_count 3
[DEBUG] [auto_pilot]: WaitForGPS: GPS available
[DEBUG] [auto_pilot]: WaitForVehicleStatus: called
[DEBUG] [auto_pilot]: WaitForVehicleStatus: Vehicle status available
[INFO] [Drone]: Run: Pre-flight checks OK
[INFO] [auto_pilot]: TakeOff: called: height 10.000000
[DEBUG] [auto_pilot]: SendArm: called: arm: 1
[DEBUG] [auto_pilot]: SendVehicleCommand: command 400
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: SendArm: wait_count 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 82.819275%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977419, long 85455939, alt 488163
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: SendTakeoff: taking off
[DEBUG] [auto_pilot]: SendVehicleCommand: command 22
[DEBUG] [auto_pilot]: WaitForLanded: Off the ground
[INFO] [auto_pilot]: TakeOff: Taking off
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 81.376122%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 79.582123%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473977582, long 85455577, alt 489941
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 77.658417%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 75.686836%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473978141, long 85454502, alt 490056
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 17, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[INFO] [auto_pilot]: Land: called.
[DEBUG] [auto_pilot]: SendLand: called
[DEBUG] [auto_pilot]: SendVehicleCommand: command 21
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 73.697517%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473978657, long 85453494, alt 490231
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 71.701668%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 69.703339%
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473978629, long 85453549, alt 489452
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 67.704201%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 65.704636%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473978495, long 85453842, alt 488238
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 63.704918%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473978488, long 85453856, alt 488054
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 61.705254%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 2, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 0
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 59.705544%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: WaitForLanded: Landed
[DEBUG] [auto_pilot]: SendArm: called: arm: 0
[DEBUG] [auto_pilot]: SendVehicleCommand: command 400
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: SendArm: wait_count 1
[INFO] [auto_pilot]: Land: landed.
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473978488, long 85453856, alt 488054
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 58.356812%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 57.856514%
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473978488, long 85453856, alt 488054
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 57.671501%
[DEBUG] [auto_pilot]: VehicleLandDetectedCallback: called: landed 1
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: arming_state 1, nav_state 18, hil_state 0, failsafe 0
[DEBUG] [auto_pilot]: VehicleStatusCallback: called: system_type 2, system_id 1, component_id 1, vehicle_type 1
[DEBUG] [auto_pilot]: VehicleGpsPositionCallback: called: lat 473978488, long 85453856, alt 488056
[DEBUG] [auto_pilot]: BatteryStatusCallback: called: remaining 57.603119%
[INFO] [Drone]: Run: success
```

```text
INFO  [commander] ARMED by Arm/Disarm component command
INFO  [commander] DISARMED by Auto disarm initiated
INFO  [logger] closed logfile, bytes written: 2626159

INFO  [commander] ARMED by Arm/Disarm component command
INFO  [logger] Start file log (type: full)
INFO  [navigator] Using minimum takeoff altitude: 2.50 m
INFO  [logger] [logger] ./log/2020-07-31/14_00_36.ulg
INFO  [logger] Opened full log file: ./log/2020-07-31/14_00_36.ulg
INFO  [commander] Takeoff detected
INFO  [commander] Landing at current position
INFO  [commander] Landing detected
INFO  [commander] DISARMED by Arm/Disarm component command
INFO  [logger] closed logfile, bytes written: 853622
```

In Commander::handle_command(), there is a comment in the case for
VEHICLE_CMD_NAV_TAKEOFF that says `/* ok, home set, use it to take off */`.
May need to set the home position first.  Trying this with
VEHICLE_CMD_DO_SET_HOME using current position.  Home position has no effect
on taking off.

This could be a side effect of auto disarm.  The first time always ends up
with `INFO  [commander] DISARMED by Auto disarm initiated` so the state
this leaves the system is one that allows take off the next time.

### Attempt at using mssion waypoints

```text
INFO  [commander] ARMED by Arm/Disarm component command
WARN  [commander] Mission start denied! No valid mission
INFO  [commander] DISARMED by Arm/Disarm component command
INFO  [logger] closed logfile, bytes written: 2438979
```

Sequence using MAVROS (from here:)
https://gist.github.com/shakthi-prashanth-m/cb70406b8786b80a17b520cce663f3b8
) is:

1. Wait for connection.
2. Arm.
3. Push waypoints.
4. Set mode to auto mission.

### Implement offboard example

[Offboard example](https://dev.px4.io/v1.10/en/ros/mavros_offboard.html) uses MAVROS.

The example uses:
Subscriber: `mavros/state` - mavros_msgs::State.connected
Publisher: `mavros/setpoint_position/local` - geometry_msgs::PoseStamped
Service client: `mavros/cmd/arming` mavros_msgs::CommandBool
Service client: `mavros/set_mode` - mavros_msgs::SetMode

Equivalents in px4_ros_com are:

* connected  - `WaitforGPS` has the same effect.
* cmd/arming - The function `Arm` does this.
* setpoint_position/local - NEW -
* set_mode - NEW - VEHICLE_CMD_DO_SET_MODE

Added SendDoSetMode() that sends VEHICLE_CMD_DO_SET_MODE.

This doesn't work the same because the example uses MavLink and I need to do
a load of other things to get it to work.

### Implement auto take off and land

While I was looking offboard/mission waypoints, I discovered various auto
modes, e.g. auto take off, auto loiter.

Tried auto take off and land.  Take off now happens 100% of the time but a
fail safe is triggered, so auto RTL mode kicks in and lands the drone.

```text
INFO  [commander] ARMED by Arm/Disarm component command
INFO  [navigator] Using minimum takeoff altitude: 2.50 m
INFO  [commander] Takeoff detected
WARN  [commander] Failsafe enabled: no datalink
INFO  [commander] Failsafe mode activated
INFO  [navigator] RTL HOME activated
INFO  [navigator] RTL: landing at home position.
INFO  [navigator] RTL: climb to 498 m (10 m above destination)
INFO  [commander] Failsafe mode deactivated
INFO  [commander] Landing detected
INFO  [commander] DISARMED by Auto disarm initiated
INFO  [logger] closed logfile, bytes written: 1575442
```

Now to find out how to stop the fail safe and make it loiter after take off.
Added call to loiter after take off.

The message "Failsafe enabled: no datalink" comes from
PX4/Firmware/src/modules/commander/state_machine_helper.cpp.  There are many
things that need to be in place to allow loitering.  What causes the
"no datalink" message is the line:

```c++
if (status->data_link_lost && data_link_loss_act_configured && !landed && is_armed) {
```

`!landed` is fine as is `is_armed`.  Investigating the other two.

`data_link_loss_act_configured`  Set by this code:

```c++
const bool data_link_loss_act_configured = data_link_loss_act > link_loss_actions_t::DISABLED;
```

`status->data_link_lost` This looks like it should be set by some sort of
heartbeat mechanism and it has an automatic time out.  This is set by the
function `Commander::data_link_check()` that is called from the main loop in
`Commander::Run()`.  There is a uORB subscriber that listens to
`ORB_ID(telemetry_status)` messages that come from Mavlink.

I can add the `telemetry_status` to `px4_ros_com` and then send updates from
the Drone instance.  The Mavlink code `Mavlink::publish_telemetry_status()`
publishes a heart beat once a second as long as message are being received by
the Mavlink simulator.

The struct `telemetry_status_s` is autogenerated and placed in this file:
`./build/px4_sitl_rtps/uORB/topics/telemetry_status.h` that is generated from
the file: `PX4/Firmware/msg/telemetry_status.msg`.

To make this work, I need to:

1. Add the telemetry_status message to the uRTPS client and agent. DONE.
2. Get Drone to send a telemetry_status message 2 times a second as
heart beat.  The message should contain:

```c++
  telemetry_status_s telemetry;

  telemetry.timestamp = now();
  telemetry.heartbeat_time = now();
  telemetry.type = telemetry_status_s::LINK_TYPE_USB;
  telemetry.remote_type = telemetry_status_s::MAV_TYPE_ONBOARD_CONTROLLER;

  // There is only one place in the Firware code that uses
  // telemetry.remote_component_id.  This is tested in Commander.cpp against
  // telemetry_status_s::COMPONENT_ID_OBSTACLE_AVOIDANCE
  // So use this value until obstacle avoidance is actually used.
  telemetry.remote_component_id = telemetry_status_s::COMPONENT_ID_ALL;
```

Message being sent OK but the uRTPS client is rejecting it.
`WARN  [micrortps_client] Unexpected topic ID`
As I modified the template code to print out the ID number, the build system
is somehow using an old version of the client.

Worked out that I am using the PX4 instance being built from the Gazebo
learning repo.  Time to fix the workaround that I have been using for a while.

#### Fix start up to use latest version of PX4 code

The workaround in manual_start.bash is no longer useful.  It is:

```bash
    echo "Run the following:"
    echo
    echo "cd ~/gazebo_learning_ws"
    echo ". /opt/ros/eloquent/setup.bash"
    echo ". /usr/share/gazebo/setup.sh"
    echo ". ./install/local_setup.bash"
    echo "colcon test --merge-install --packages-select drone_demo_system_tests"
    echo
    echo "Then rename /tmp/tmpXXXXX to /tmp/px4"
```

Running the test of `drone_demo_system_tests` has the side-efffect of creating
a copy of everything needed to run the PX4 instance.  A minimal replacement
is needed that creates the same directory in /tmp/px4 using the latest code.

`manual_start.bash` needs to be renamed, e.g. `auto_start.bash` and then
modified to call a script that does the minimal work to create the PX4
instance.

The `/tmp/px4` directory is only used by PX4, so the new code can be put in
the existing script `px4.bash`.

In the Gazebo learning repo,, the test code calls
`test_system_yosemite_launch.py`.  This is a hugely cut down version of the
original code that does a load of stuf that we don't need and then calls
`sitl_launcher/scripts/launch_drone_ros2.py --iris 0` that we do need.

Modified `px4.bash` to create the rootfs dir `/tmp/px4`.  Works.

#### USB is the wrong thing to use

The telemtry_status message is now being handled correctly so another step
closer to the end goal.  The next problem is that PX4 does not like me
telling it that I am using a USB connection.

```text
INFO  [micrortps_client] Connected to server!
INFO  [ecl/EKF] 560000: GPS checks passed
INFO  [ekf2] Mag sensor ID changed to 197388
INFO  [ecl/EKF] 2868000: EKF aligned, (baro hgt, IMU buf: 18, OBS buf: 14)
INFO  [ecl/EKF] 2868000: reset position to last known position
INFO  [ecl/EKF] 2868000: reset velocity to zero
INFO  [ecl/EKF] 5080000: reset position to GPS
INFO  [ecl/EKF] 5080000: reset velocity to GPS
INFO  [ecl/EKF] 5080000: starting GPS fusion
WARN  [commander] Connection to mission computer lost
WARN  [PreFlightCheck] Arming denied! Flying with USB is not safe
INFO  [commander] Onboard controller regained
WARN  [commander] Connection to mission computer lost
INFO  [commander] Onboard controller regained
WARN  [commander] Connection to mission computer lost
INFO  [commander] Onboard controller regained
WARN  [commander] Connection to mission computer lost
INFO  [commander] Onboard controller regained
WARN  [commander] Connection to mission computer lost
```

Back to reviewing the code. Set the type = 0 (LINK_TYPE_GENERIC).  Now I get
this:

```text
INFO  [ecl/EKF] 5056000: starting GPS fusion
WARN  [commander] Connection to mission computer lost
INFO  [commander] ARMED by Arm/Disarm component command
WARN  [commander] Failsafe enabled: No manual control stick input
INFO  [commander] Failsafe mode activated
INFO  [navigator] RTL HOME activated
INFO  [navigator] RTL: landing at home position.
WARN  [uorb] orb_advertise_multi: failed to set queue size
INFO  [commander] Failsafe mode deactivated
INFO  [commander] Onboard controller regained
```

Lost code:

```c++
  if ((_datalink_last_heartbeat_onboard_controller > 0)
    && (hrt_elapsed_time(&_datalink_last_heartbeat_onboard_controller) > 5_s)
    && !_onboard_controller_lost) {
      mavlink_log_critical(&mavlink_log_pub, "Connection to mission computer lost");
      _onboard_controller_lost = true;
      _status_changed = true;
  }
```

Regained code:

```c++
        if (_onboard_controller_lost) {
          if (telemetry.heartbeat_time > _datalink_last_heartbeat_onboard_controller) {
            mavlink_log_info(&mavlink_log_pub, "Onboard controller regained");
            _onboard_controller_lost = false;
            _status_changed = true;
          }
        }
```

It must be something to do with the value of
`_datalink_last_heartbeat_onboard_controller` not being updated.
Logic all looks fine.

The message `Failsafe enabled: No manual control stick input` uses the string
`reason_no_rc` and is printed when `enable_failsafe` is called. Need to make
sure `rc_lost` is true.  This is set when `set_nav_state` is called like this:

```c++
const bool rc_lost = rc_loss_act_configured && (status->rc_signal_lost);
```

`rc_loss_act_configured` and `status` are parameters. `status.rc_signal_lost`
is set to `false` by the following if statement:

```c++
    if (!status_flags.rc_input_blocked && _manual_control_setpoint.timestamp != 0 &&
        (hrt_elapsed_time(&_manual_control_setpoint.timestamp) < (_param_com_rc_loss_t.get() * 1_s))) {
```

Changing `status_flags.rc_input_blocked` is not an option.  So we need to
ensure that `_manual_control_setpoint.timestamp` is updated regularly.  The
messages are ignored unless the joystick positions change so this is fine.

1. Enabled manual control setpoint messages as receive.
2. Implement functions to send these messages twice a second.

Fixed the problem causing the message "No manual control stick input".

#### Connection to mission computer lost

The drone does what I tell it to but produces many messages like this:

```text
INFO  [commander] Onboard controller regained
WARN  [commander] Connection to mission computer lost
```

Disabling the sending of the heartbeat message stops this error message.
Changing the frequency of the heartbeat message has no effect, so I suspect
that I either need to do something else or there is a bug in the heartbeat
handling code.  FIXME #30

Heartbeat disabled.

Send LOITER mode once, and then waiting for 10 seconds causes this.

```text
INFO  [commander] Takeoff detected
WARN  [commander] Failsafe enabled: No manual control stick input
INFO  [commander] Failsafe mode activated
```

This is a misleading warning as manual_control_setpoint is being sent every
500ms so this should not happen.  No change in output or behaviour when rate
of sending 10Hz or 1.2Hz.

I suspect that something needs to know what it is going to do next. Looking at
what happens when navigator finishes doing takeoff.

The code in PX4 navigator_main.cpp seems to do the right thing.

<https://docs.px4.io/master/en/flight_modes/> says
Takeoff. Auto. Position fix required (e.g. GPS). Vehicle ascends to takeoff
altitude and holds position.

The code seems to mathc this statment.  The problem is most likely the
failssafe.

Installed `pyulog` to analyse the log files like this:

```bash
git clone https://github.com/PX4/pyulog.git
cd pyulog/
sudo python setup.py build install
ulog_messages /tmp/px4/log/2020-08-11/08_59_44.ulg
```

Log files have time stamps but don't show the warning messages. The failsafe
cuts in 5 seconds after the take off command is received.

```text
1:43:29 INFO: [logger] [logger] ./log/2020-08-11/09_00_22.ulg
1:43:29 INFO: [logger] Opened full log file: ./log/2020-08-11/09_00_22.ulg
1:43:30 INFO: [navigator] Using minimum takeoff altitude: 2.50 m
1:43:32 INFO: [commander] Takeoff detected
1:43:35 INFO: [navigator] RTL HOME activated
1:43:35 INFO: [navigator] RTL: landing at home position.
1:43:35 INFO: [navigator] RTL: climb to 499 m (10 m above destination)
1:43:35 INFO: [commander] Failsafe mode deactivated
1:43:39 INFO: [commander] Landing at current position
1:43:54 INFO: [commander] Landing detected
1:43:54 INFO: [commander] DISARMED by Arm/Disarm component command
```

This looks like the value `rc_lost` is being set true in
`state_machine_helper.cpp` function `set_nav_state`.  This is true when the
following are true:

```c++
rc_lost = (rc_loss_act > link_loss_actions_t::DISABLED) &&
          (status->rc_signal_lost);
```

It looks like the "No manual stick input" message is generated on entry to
Loiter mode.  Disabling Loiter.  This has no effect so it must be something
else.

I'm sending the following messages:

* SendArm: called: arm: 0/1
  px4_msgs::msg::VehicleCommand::VEHICLE_CMD_COMPONENT_ARM_DISARM
* SendManualControlSetpoint - every 500ms
  px4_msgs::msg::ManualControlSetpoint
* SendDoSetMode: auto takeoff
  px4_msgs::msg::VehicleCommand::VEHICLE_CMD_DO_SET_MODE
    PX4_CUSTOM_MAIN_MODE_AUTO = 4
    PX4_CUSTOM_SUB_MODE_AUTO_TAKEOFF = 2
* SendLand: called
  px4_msgs::msg::VehicleCommand::VEHICLE_CMD_NAV_LAND

Looking at `Commander::run()` again.  Main flow is:

1. Set up for while loop.
2. while until exit
    1. Update parameters.  This is the values in the params file.
    2. Handle power button state changes.
    3. Manual control setpoint update. Just get the data.
    4. Offboard control update. Checks with _offboard_control_mode_sub.
    5. System power update.
    6. Safety update.  A safety button?
    7. VTOL status. Not relevent for Iris.
    8. ESC status update.  Not relevent for sim.
    9. Estimator check (). Check local and GPS position.
    10. Land detector.
    11. Auto-disarm when landed or kill switch.
    12. Battery status check ().  OK.
    13. Subsystem check.  Calls to set_health_flags update the status structure.
    14. Mission result check.
    15. Geofence check.
    16. Check mission flight termination.
    17. RC input check. Complicated.
    18. data_link_check(). Only for onboard (offboard, mission) computer mode.
    19. avoidance_check().
    20. Engine failure detection.
    21. Reset main state to loiter or auto-mission after takeoff.
        This might be it!  I might need to do something about setting
        mission_result as it will only loiter when...

        ```c++
        if (_internal_state.main_state == commander_state_s::MAIN_STATE_AUTO_TAKEOFF
          && (_mission_result_sub.get().timestamp > _internal_state.timestamp)
          && _mission_result_sub.get().finished) {
        ```

    22. Wait for RC signal in loiter.
    23. Handle commands.
    24. Failure detector.
    25. Automatically set/update home position.
    26. Check for arming state change.
    27. Set nav state.
    28. Publish states.
    29. Play tunes.
    30. Blink LED.
3. Join thread and tidy up.

It looks like the hour or so I spent picking through this might be useful.
Item 21 shows that I need to do somthing with the mission result timestamp
and finished values.

I need to understand how mission_result is used in PX4.  Where is used?

* Commander - subscriber
* MavlinkMissionManager - subscriber
* Navigator - publisher
  Much of the work is done in Navigator/Mission.

Setting mission result is done by calling `set_mission_result_updated()`.
Need to set `mission_result.finished` = true.
Set true in Mavigator/Takeoff.
Worked out how to get debug into the log file:

```c++
mavlink_log_info(&mavlink_log_pub, "AJB: Completed takeoff.  Loitering...");
```

Added debug to confirm this.  The log file shows this:

```text
0:00:26 INFO: [navigator] AJB: Completed takeoff.  Loitering...
0:00:26 INFO: [commander] Failsafe mode activated
0:00:26 INFO: [navigator] RTL: landing at home position.
```

It is definitely around this area.  The debug shows that it is going into
loitering mode but then fails.  Best guess is that it goes into
`set_nav_state()` as just after this the message "Failsafe mode activated" is
printed, `status.failsafe == true`.

Added debug to `set_nav_state()`.  `rc_lost` is true!  Investigating.
Latest run shows `rc_signal_lost == true` for entire run.
`rc_signal_lost` is set true by the Command constructor and never set false.
The logic that protects this is:

```c++
if (!status_flags.rc_input_blocked && _manual_control_setpoint.timestamp != 0 &&
    (hrt_elapsed_time(&_manual_control_setpoint.timestamp) < (_param_com_rc_loss_t.get() * 1_s))) {
```

SetPoint message is sent every 500ms so it should not be that.
Adding debug.
Timestamps are being received. timeout goes from true at start to false.
Timestamp received = true before arming so my messages are getting through.
status_flags.rc_input_blocked never changes from false.

The output with my debug enabled is:

```text
# Start
...
INFO  [commander] AJB: changed rc_blocked 0
INFO  [commander] AJB: changed mcs_timestamp_received 0
...
INFO  [commander] AJB: max_loss_time_us 500000, changed mcs_timeout 0
...
INFO  [commander] AJB: set_nav_state: main_state 4, nav_state_old 4, rc_loss_act 2, rc_signal_lost 1
...
# Started drone
INFO  [commander] AJB: changed mcs_timestamp_received 1
INFO  [commander] ARMED by Arm/Disarm component command
WARN  [commander] Failsafe enabled: No manual control stick input
INFO  [commander] Failsafe mode activated
INFO  [navigator] RTL HOME activated
INFO  [navigator] RTL: landing at home position.
WARN  [uorb] orb_advertise_multi: failed to set queue size
INFO  [commander] AJB: set_nav_state: main_state 5, nav_state_old 5, rc_loss_act 2, rc_signal_lost 1
INFO  [commander] Failsafe mode deactivated
INFO  [navigator] Using minimum takeoff altitude: 2.50 m
INFO  [commander] AJB: set_nav_state: main_state 10, nav_state_old 17, rc_loss_act 2, rc_signal_lost 1
INFO  [commander] Takeoff detected
INFO  [navigator] AJB: Completed takeoff.  Loitering...
INFO  [commander] AJB: Completed takeoff.  Loitering...
WARN  [commander] Failsafe enabled: No manual control stick input
INFO  [commander] Failsafe mode activated
INFO  [navigator] RTL HOME activated
INFO  [navigator] RTL: landing at home position.
INFO  [navigator] RTL: climb to 499 m (10 m above destination)
INFO  [commander] AJB: set_nav_state: main_state 5, nav_state_old 5, rc_loss_act 2, rc_signal_lost 1
INFO  [commander] Failsafe mode deactivated
WARN  [commander] Return to launch denied
INFO  [navigator] RTL: return at 499 m (10 m above destination)
INFO  [navigator] RTL: land at destination
INFO  [commander] Landing detected
INFO  [commander] DISARMED by Arm/Disarm component command
INFO  [logger] closed logfile, bytes written: 3257671

```

mcs_timeout never gets set to true. Added more debug:

```text
0:00:27 INFO: [commander] AJB: elapsed_time_us 27316000
0:00:27 INFO: [commander] AJB: elapsed_time_us 27328000
0:00:27 INFO: [commander] AJB: changed mcs_timestamp_received 1
0:00:27 INFO: [commander] AJB: elapsed_time_us 18445146908847253202
0:00:27 INFO: [commander] AJB: elapsed_time_us 18445146908847265202
```

When the timestamp is received, there is a number problem!

Of course, I am sending the timestamp of the PC system clock and the
PX4 is expecting the timestamp to be comparable to the PX4 clock.

Need a way to get the PX4 clock to the PC so that I can use it as a base to
send back.

#### Timesync

Adding timesync callback.

[DEBUG] [auto_pilot]: Timesync; timestamp 92185577533, seq_id 0, seq 183, tc1 0, ts1 92185448105406
[DEBUG] [auto_pilot]: Timesync; timestamp 92186078670, seq_id 0, seq 188, tc1 0, ts1 92185949243289
[DEBUG] [auto_pilot]: Timesync; timestamp 92186579217, seq_id 0, seq 193, tc1 0, ts1 92186449791321

Not sure what the timestamp is relative to.

Timesysnc is best explained in this thread.
https://github.com/mavlink/mavlink-devguide/issues/194#issuecomment-512037079

Timestamp units are:
timestamp   us
tc1, ts1    ns

Where do the times come from?
  getMonoTimeUSec()
  getMonoRawTimeNSec()
Both use:
 clock_gettime()

```c++
  inline int64_t getMonoRawTimeNSec() {
    timespec t;
    clock_gettime(CLOCK_MONOTONIC_RAW, &t);
    return static_cast<int64_t>(t.tv_sec * 1000000000LL + t.tv_nsec);
  }
```

The time used by Timesync is clock_gettime().

The Timesync messages are being handled by the URTPS agent so I don't need
to think about the actual synchronisation between the PC and the PX4 instance.

#### Manual Setpoint Timestamp second attempt

The problem really is the numbers that end up in the time stamp.  What is
needed is the local timestamp of receipt to be used for detecting if the link
is present or not.

Examine the data coming in.  The problem is caused by the sum in
hrt_elapsed_time() as the external time is subtracted from the current local
time.  If the external time is larger than the internal time, the result is a
massive positive number due to wrap round of the uint64_t being used.  This is
what the results show.

How to fix it? Latest timestamp - last timestamp will work but for, some reason,
when I need to test it, latest is equal to last, so it is no use.  Looking
at when last is set to latest.

Set equal in Commander::set_main_state_rc().
set_main_state_rc called by Commander::set_main_state().
Commander::set_main_state() called by Commander::run() line 2052.
This is after the code I'm using, so it should be OK.

The last timestamp is always 0, so something is going wrong.  Added
copy of current to last in Commander::run().  Now I get this:

```text
0:00:34 INFO: [navigator] Using minimum takeoff altitude: 2.50 m
0:00:34 INFO: [commander] AJB: set_nav_state: main_state 10, nav_state_old 17, rc_loss_act 2, rc_signal_lost 1
0:00:34 INFO: [commander] AJB: last 1597212278625160, current 1597212278625160, elapsed_time_us 0
0:00:34 INFO: [commander] AJB: last 1597212279123692, current 1597212279123692, elapsed_time_us 0
0:00:34 INFO: [commander] AJB: last 1597212279123692, current 1597212279123692, elapsed_time_us 0
0:00:35 INFO: [commander] AJB: last 1597212279123692, current 1597212279622339, elapsed_time_us 498647
0:00:35 INFO: [commander] AJB: last 1597212279622339, current 1597212279622339, elapsed_time_us 0
0:00:35 INFO: [commander] AJB: last 1597212279622339, current 1597212279622339, elapsed_time_us 0
0:00:35 INFO: [commander] AJB: last 1597212280120268, current 1597212280120268, elapsed_time_us 0
0:00:35 INFO: [commander] Takeoff detected
0:00:36 INFO: [commander] AJB: last 1597212280120268, current 1597212280120268, elapsed_time_us 0
0:00:36 INFO: [commander] AJB: last 1597212280617804, current 1597212280617804, elapsed_time_us 0
0:00:36 INFO: [commander] AJB: last 1597212280617804, current 1597212280617804, elapsed_time_us 0
0:00:36 INFO: [commander] AJB: last 1597212281113700, current 1597212281113700, elapsed_time_us 0
0:00:36 INFO: [commander] AJB: last 1597212281113700, current 1597212281113700, elapsed_time_us 0
0:00:37 INFO: [commander] AJB: last 1597212281609194, current 1597212281609194, elapsed_time_us 0
0:00:37 INFO: [commander] AJB: last 1597212281609194, current 1597212281609194, elapsed_time_us 0
0:00:37 INFO: [commander] AJB: last 1597212282103781, current 1597212282103781, elapsed_time_us 0
0:00:37 INFO: [commander] AJB: last 1597212282595212, current 1597212282595212, elapsed_time_us 0
0:00:38 INFO: [commander] AJB: last 1597212282595212, current 1597212282595212, elapsed_time_us 0
0:00:38 INFO: [commander] AJB: last 1597212283079890, current 1597212283079890, elapsed_time_us 0
0:00:38 INFO: [commander] AJB: last 1597212283079890, current 1597212283079890, elapsed_time_us 0
0:00:38 INFO: [commander] AJB: last 1597212283565138, current 1597212283565138, elapsed_time_us 0
0:00:39 INFO: [commander] AJB: Completed takeoff.  Loitering...
0:00:39 INFO: [navigator] RTL: landing at home position.
0:00:39 INFO: [navigator] RTL: climb to 499 m (10 m above destination)
0:00:39 INFO: [commander] AJB: set_nav_state: main_state 5, nav_state_old 5, rc_loss_act 2, rc_signal_lost 1
0:00:39 INFO: [commander] Failsafe mode deactivated
0:00:39 INFO: [commander] AJB: last 1597212283565138, current 1597212283565138, elapsed_time_us 0
0:00:39 INFO: [commander] AJB: last 1597212283565138, current 1597212284050999, elapsed_time_us 485861
0:00:39 INFO: [commander] AJB: last 1597212284050999, current 1597212284050999, elapsed_time_us 0
0:00:39 INFO: [commander] AJB: last 1597212284050999, current 1597212284535996, elapsed_time_us 484997
```

This tells me that placing the last = current code just before the message
fetch is wrong.

I need to timestamp the manual control setpoint message using the local
timestamp.  Added this code.  Now I get this:

```text
INFO  [commander] AJB: _last_manual_control_setpoint_received 0, elapsed_time_us 27860000
INFO  [commander] AJB: changed mcs_timestamp_received 1
INFO  [commander] AJB: max_loss_time_us 500000, changed mcs_timeout 1
INFO  [commander] AJB: _last_manual_control_setpoint_received 28064000, elapsed_time_us 36000
INFO  [commander] AJB: _last_manual_control_setpoint_received 28064000, elapsed_time_us 276000
# This does not change main state.
INFO  [commander] ARMED by Arm/Disarm component command

# What causes this happen?
WARN  [commander] Failsafe enabled: No manual control stick input
INFO  [commander] Failsafe mode activated
INFO  [navigator] RTL HOME activated
INFO  [navigator] RTL: landing at home position.
WARN  [uorb] orb_advertise_multi: failed to set queue size

# What causes rc_signal_lost = true?
# Main and old state = MAIN_STATE_AUTO_RTL.
INFO  [commander] AJB: set_nav_state: main_state 5, nav_state_old 5, rc_loss_act 2, rc_signal_lost 1

# What causes the deactivation?
INFO  [commander] Failsafe mode deactivated
INFO  [commander] AJB: _last_manual_control_setpoint_received 28448000, elapsed_time_us 132000
INFO  [commander] AJB: _last_manual_control_setpoint_received 28736000, elapsed_time_us 84000
INFO  [commander] AJB: _last_manual_control_setpoint_received 28736000, elapsed_time_us 324000
INFO  [commander] AJB: _last_manual_control_setpoint_received 29240000, elapsed_time_us 60000
INFO  [navigator] Using minimum takeoff altitude: 2.50 m
INFO  [commander] AJB: _last_manual_control_setpoint_received 29240000, elapsed_time_us 300000

# Still rc_signal_lost = true?  Messages are being received.
INFO  [commander] AJB: set_nav_state: main_state 10, nav_state_old 17, rc_loss_act 2, rc_signal_lost 1
INFO  [commander] AJB: _last_manual_control_setpoint_received 29732000, elapsed_time_us 48000
INFO  [commander] AJB: _last_manual_control_setpoint_received 29732000, elapsed_time_us 287999
INFO  [commander] AJB: _last_manual_control_setpoint_received 30223999, elapsed_time_us 36001
INFO  [commander] AJB: _last_manual_control_setpoint_received 30223999, elapsed_time_us 276001
INFO  [commander] AJB: _last_manual_control_setpoint_received 30716000, elapsed_time_us 24000
INFO  [commander] AJB: _last_manual_control_setpoint_received 30716000, elapsed_time_us 263999
INFO  [commander] AJB: _last_manual_control_setpoint_received 31171999, elapsed_time_us 48001
INFO  [commander] Takeoff detected
INFO  [commander] AJB: _last_manual_control_setpoint_received 31171999, elapsed_time_us 288001
INFO  [commander] AJB: _last_manual_control_setpoint_received 31604000, elapsed_time_us 96000
INFO  [commander] AJB: _last_manual_control_setpoint_received 31604000, elapsed_time_us 336000
INFO  [commander] AJB: _last_manual_control_setpoint_received 32096000, elapsed_time_us 84000
INFO  [commander] AJB: _last_manual_control_setpoint_received 32096000, elapsed_time_us 324000
INFO  [commander] AJB: _last_manual_control_setpoint_received 32492000, elapsed_time_us 168000
INFO  [commander] AJB: _last_manual_control_setpoint_received 32492000, elapsed_time_us 408000
INFO  [commander] AJB: _last_manual_control_setpoint_received 32996000, elapsed_time_us 144000
INFO  [commander] AJB: _last_manual_control_setpoint_received 33380000, elapsed_time_us 0
INFO  [commander] AJB: _last_manual_control_setpoint_received 33380000, elapsed_time_us 240000
INFO  [commander] AJB: _last_manual_control_setpoint_received 33380000, elapsed_time_us 480000
INFO  [commander] AJB: _last_manual_control_setpoint_received 33872000, elapsed_time_us 228000
INFO  [commander] AJB: _last_manual_control_setpoint_received 33872000, elapsed_time_us 468000
INFO  [navigator] AJB: Completed takeoff.  Loitering...
INFO  [commander] AJB: Completed takeoff.  Loitering...

# What causes the failsafe?
WARN  [commander] Failsafe enabled: No manual control stick input
INFO  [commander] Failsafe mode activated
INFO  [navigator] RTL HOME activated
INFO  [navigator] RTL: landing at home position.
INFO  [navigator] RTL: climb to 498 m (10 m above destination)
INFO  [commander] AJB: set_nav_state: main_state 5, nav_state_old 5, rc_loss_act 2, rc_signal_lost 1
# What causes the deactivation?
INFO  [commander] Failsafe mode deactivated
INFO  [commander] AJB: _last_manual_control_setpoint_received 34364000, elapsed_time_us 216000
INFO  [commander] AJB: _last_manual_control_setpoint_received 34364000, elapsed_time_us 456000
INFO  [commander] AJB: _last_manual_control_setpoint_received 34856000, elapsed_time_us 204000
INFO  [commander] AJB: _last_manual_control_setpoint_received 34856000, elapsed_time_us 444000
INFO  [commander] AJB: _last_manual_control_setpoint_received 35348000, elapsed_time_us 192000
INFO  [commander] AJB: _last_manual_control_setpoint_received 35348000, elapsed_time_us 432000
INFO  [commander] AJB: _last_manual_control_setpoint_received 35852000, elapsed_time_us 168000
INFO  [commander] AJB: _last_manual_control_setpoint_received 36248000, elapsed_time_us 12000
INFO  [commander] AJB: _last_manual_control_setpoint_received 36248000, elapsed_time_us 252000
INFO  [commander] AJB: _last_manual_control_setpoint_received 36728000, elapsed_time_us 12000
INFO  [commander] AJB: _last_manual_control_setpoint_received 36728000, elapsed_time_us 252000
INFO  [commander] AJB: _last_manual_control_setpoint_received 37124000, elapsed_time_us 96000
INFO  [commander] AJB: _last_manual_control_setpoint_received 37124000, elapsed_time_us 336000
INFO  [commander] AJB: _last_manual_control_setpoint_received 37616000, elapsed_time_us 84000
INFO  [commander] AJB: _last_manual_control_setpoint_received 37616000, elapsed_time_us 324000
INFO  [commander] AJB: _last_manual_control_setpoint_received 38108000, elapsed_time_us 72000
INFO  [commander] AJB: _last_manual_control_setpoint_received 38108000, elapsed_time_us 312000
INFO  [commander] AJB: _last_manual_control_setpoint_received 38612000, elapsed_time_us 48000
INFO  [commander] AJB: _last_manual_control_setpoint_received 38612000, elapsed_time_us 288000

# Already in RTL mode so this is expected.
WARN  [commander] Return to launch denied
INFO  [commander] AJB: _last_manual_control_setpoint_received 39092000, elapsed_time_us 48000
INFO  [commander] AJB: _last_manual_control_setpoint_received 39092000, elapsed_time_us 288000
INFO  [commander] AJB: _last_manual_control_setpoint_received 39584000, elapsed_time_us 36000
INFO  [navigator] RTL: return at 498 m (10 m above destination)
INFO  [navigator] RTL: land at destination
INFO  [commander] AJB: _last_manual_control_setpoint_received 39584000, elapsed_time_us 276000
```

FIXME: There is also a problem with the failsafe.  After arming, the failsafe
cuts in and causes the drone to take off when it is on the ground.  The correct
failsafe is to disarm.

`rc_signal_lost` is still true so something else is wrong.
The arm code must do its own thing as it seems to enable the failsafe, not
`set_nav_state()`.

##### Failsafe after arming

ArmDisarm debug output comes from function `Commander::handle_command` that is
called from `Commander::run`.

"Failsafe enabled: No manual control stick input" debug used in 4 places in
state_machine_helper.cpp in function `set_nav_state`:

* All manual modes: MAIN_STATE_ACRO, MAIN_STATE_MANUAL, MAIN_STATE_RATTITUDE,
  MAIN_STATE_STAB, MAIN_STATE_ALTCTL
* MAIN_STATE_POSCTL
* MAIN_STATE_AUTO_LOITER
* MAIN_STATE_ORBIT

Set mode needed before arming?  Might be helpful but all calls to
`enable_failsafe` have logic before them using `rc_lost`.

Back to making sure `rc_lost` is false when `set_nav_state` is called. This
means that `status->rc_signal_lost` must be false on entry to prevent the
fail safe.

Added more debug Commander. Also fixed another potential problem.

Too verbose
  "AJB: _last_manual_control_setpoint_received"
More debug:
  Need to know which state is causing "No manual control stick input".

This time the run looks like this:

```text
INFO  [commander] AJB: _last_manual_control_setpoint_received 0, elapsed_time_us 32436000
INFO  [commander] AJB: changed mcs_timestamp_received 1
INFO  [commander] AJB: max_loss_time_us 500000, changed mcs_timeout 1
INFO  [commander] AJB: _last_manual_control_setpoint_received 32544000, elapsed_time_us 132000
INFO  [commander] AJB: _last_manual_control_setpoint_received 32544000, elapsed_time_us 372000
INFO  [commander] ARMED by Arm/Disarm component command
INFO  [commander] AJB: set_nav_state: main_state 4,is_armed 1, rc_signal_lost 1
INFO  [commander] AJB: set_nav_state: main_state 4
WARN  [commander] Failsafe enabled: No manual control stick input
INFO  [commander] Failsafe mode activated
INFO  [navigator] RTL HOME activated
INFO  [navigator] RTL: landing at home position.
WARN  [uorb] orb_advertise_multi: failed to set queue size
INFO  [commander] AJB: set_nav_state: main_state 5,is_armed 1, rc_signal_lost 1
INFO  [commander] Failsafe mode deactivated
INFO  [commander] AJB: _last_manual_control_setpoint_received 32964000, elapsed_time_us 192000
INFO  [commander] AJB: _last_manual_control_setpoint_received 32964000, elapsed_time_us 432000
INFO  [commander] AJB: _last_manual_control_setpoint_received 33444000, elapsed_time_us 192000
INFO  [commander] AJB: _last_manual_control_setpoint_received 33444000, elapsed_time_us 432000
INFO  [navigator] Using minimum takeoff altitude: 2.50 m
INFO  [commander] AJB: set_nav_state: main_state 10,is_armed 1, rc_signal_lost 1
INFO  [commander] AJB: _last_manual_control_setpoint_received 33936000, elapsed_time_us 180000
INFO  [commander] AJB: _last_manual_control_setpoint_received 33936000, elapsed_time_us 420000
INFO  [commander] AJB: _last_manual_control_setpoint_received 34416000, elapsed_time_us 180000
INFO  [commander] AJB: _last_manual_control_setpoint_received 34416000, elapsed_time_us 420000
INFO  [commander] AJB: _last_manual_control_setpoint_received 34896000, elapsed_time_us 180000
INFO  [commander] AJB: _last_manual_control_setpoint_received 34896000, elapsed_time_us 420000
INFO  [commander] AJB: _last_manual_control_setpoint_received 35388000, elapsed_time_us 168000
INFO  [commander] AJB: _last_manual_control_setpoint_receithat ved 35388000, elapsed_time_us 408000
INFO  [commander] Takeoff detected
INFO  [commander] AJB: _last_manual_control_setpoint_received 35868000, elapsed_time_us 168000
INFO  [commander] AJB: _last_manual_control_setpoint_received 36264000, elapsed_time_us 12000
INFO  [commander] AJB: _last_manual_control_setpoint_received 36264000, elapsed_time_us 252000
INFO  [commander] AJB: _last_manual_control_setpoint_received 36756000, elapsed_time_us 0
INFO  [commander] AJB: _last_manual_control_setpoint_received 36756000, elapsed_time_us 248000
INFO  [commander] AJB: _last_manual_control_setpoint_received 36756000, elapsed_time_us 488000
INFO  [commander] AJB: _last_manual_control_setpoint_received 37256000, elapsed_time_us 228000
INFO  [commander] AJB: _last_manual_control_setpoint_received 37256000, elapsed_time_us 468000
INFO  [commander] AJB: _last_manual_control_setpoint_received 37748000, elapsed_time_us 216000
INFO  [commander] AJB: _last_manual_control_setpoint_received 37748000, elapsed_time_us 456000
INFO  [commander] AJB: _last_manual_control_setpoint_received 38252000, elapsed_time_us 192000
INFO  [commander] AJB: _last_manual_control_setpoint_received 38252000, elapsed_time_us 432000
INFO  [commander] AJB: _last_manual_control_setpoint_received 38744000, elapsed_time_us 180000
INFO  [navigator] AJB: Completed takeoff.  Loitering...
INFO  [commander] AJB: Completed takeoff.  Loitering...
INFO  [commander] AJB: set_nav_state: main_state 4
WARN  [commander] Failsafe enabled: No manual control stick input
INFO  [commander] Failsafe mode activated
INFO  [navigator] RTL HOME activated
INFO  [navigator] RTL: landing at home position.
INFO  [navigator] RTL: climb to 499 m (10 m above destination)
INFO  [commander] AJB: set_nav_state: main_state 5,is_armed 1, rc_signal_lost 1
INFO  [commander] Failsafe mode deactivated
INFO  [commander] AJB: _last_manual_control_setpoint_received 38744000, elapsed_time_us 420000
INFO  [commander] AJB: _last_manual_control_setpoint_received 39248000, elapsed_time_us 156000
INFO  [commander] AJB: _last_manual_control_setpoint_received 39248000, elapsed_time_us 396000
INFO  [commander] AJB: _last_manual_control_setpoint_received 39728000, elapsed_time_us 156000
INFO  [commander] AJB: _last_manual_control_setpoint_received 39728000, elapsed_time_us 396000
INFO  [commander] AJB: _last_manual_control_setpoint_received 40220000, elapsed_time_us 144000
INFO  [commander] AJB: _last_manual_control_setpoint_received 40604000, elapsed_time_us 0
INFO  [commander] AJB: _last_manual_control_setpoint_received 40604000, elapsed_time_us 240000
INFO  [commander] AJB: _last_manual_control_setpoint_received 40604000, elapsed_time_us 480000
INFO  [commander] AJB: _last_manual_control_setpoint_received 41108000, elapsed_time_us 216000
INFO  [commander] AJB: _last_manual_control_setpoint_received 41108000, elapsed_time_us 456000
INFO  [commander] AJB: _last_manual_control_setpoint_received 41600000, elapsed_time_us 204000
INFO  [commander] AJB: _last_manual_control_setpoint_received 41600000, elapsed_time_us 444000
INFO  [commander] AJB: _last_manual_control_setpoint_received 42092000, elapsed_time_us 192000
INFO  [commander] AJB: _last_manual_control_setpoint_received 42476000, elapsed_time_us 48000
INFO  [commander] AJB: _last_manual_control_setpoint_received 42476000, elapsed_time_us 288000
INFO  [commander] AJB: _last_manual_control_setpoint_received 42968000, elapsed_time_us 36000
INFO  [commander] AJB: _last_manual_control_setpoint_received 42968000, elapsed_time_us 276000
WARN  [commander] Return to launch denied
INFO  [commander] AJB: _last_manual_control_setpoint_received 43256000, elapsed_time_us 228000
INFO  [commander] AJB: _last_manual_control_setpoint_received 43256000, elapsed_time_us 468000
INFO  [commander] AJB: _last_manual_control_setpoint_received 43748000, elapsed_time_us 216000
INFO  [commander] AJB: _last_manual_control_setpoint_received 43748000, elapsed_time_us 456000
INFO  [navigator] RTL: return at 499 m (10 m above destination)
INFO  [navigator] RTL: land at destination
INFO  [commander] AJB: _last_manual_control_setpoint_received 44240000, elapsed_time_us 204000
INFO  [commander] AJB: _last_manual_control_setpoint_received 44240000, elapsed_time_us 444000
INFO  [commander] AJB: _last_manual_control_setpoint_received 44732000, elapsed_time_us 192000
INFO  [commander] AJB: _last_manual_control_setpoint_received 44732000, elapsed_time_us 432000
INFO  [commander] AJB: _last_manual_control_setpoint_received 45212000, elapsed_time_us 192000
INFO  [commander] AJB: _last_manual_control_setpoint_received 45212000, elapsed_time_us 432000
INFO  [commander] AJB: _last_manual_control_setpoint_received 45704000, elapsed_time_us 180000
INFO  [commander] AJB: _last_manual_control_setpoint_received 45704000, elapsed_time_us 420000
INFO  [commander] AJB: _last_manual_control_setpoint_received 46196000, elapsed_time_us 168000
INFO  [commander] AJB: _last_manual_control_setpoint_received 46196000, elapsed_time_us 408000
INFO  [commander] AJB: _last_manual_control_setpoint_received 46688000, elapsed_time_us 156000
INFO  [commander] AJB: _last_manual_control_setpoint_received 46688000, elapsed_time_us 396000
INFO  [commander] AJB: _last_manual_control_setpoint_received 47180000, elapsed_time_us 144000
INFO  [commander] AJB: _last_manual_control_setpoint_received 47180000, elapsed_time_us 384000
INFO  [commander] AJB: _last_manual_control_setpoint_received 47684000, elapsed_time_us 120000
INFO  [commander] AJB: _last_manual_control_setpoint_received 47684000, elapsed_time_us 360000
INFO  [commander] AJB: _last_manual_control_setpoint_received 48176000, elapsed_time_us 108000
INFO  [commander] AJB: _last_manual_control_setpoint_received 48176000, elapsed_time_us 348000
INFO  [commander] AJB: _last_manual_control_setpoint_received 48668000, elapsed_time_us 96000
INFO  [commander] AJB: _last_manual_control_setpoint_received 48668000, elapsed_time_us 336000
INFO  [commander] AJB: _last_manual_control_setpoint_received 49160000, elapsed_time_us 84000
INFO  [commander] AJB: _last_manual_control_setpoint_received 49160000, elapsed_time_us 324000
INFO  [commander] AJB: _last_manual_control_setpoint_received 49652000, elapsed_time_us 72000
INFO  [commander] AJB: _last_manual_control_setpoint_received 49652000, elapsed_time_us 312000
INFO  [commander] AJB: _last_manual_control_setpoint_received 50144000, elapsed_time_us 60000
INFO  [commander] AJB: _last_manual_control_setpoint_received 50144000, elapsed_time_us 300000
INFO  [commander] AJB: _last_manual_control_setpoint_received 50636000, elapsed_time_us 48000
INFO  [commander] AJB: _last_manual_control_setpoint_received 50636000, elapsed_time_us 288000
INFO  [commander] AJB: _last_manual_control_setpoint_received 51044000, elapsed_time_us 120000
INFO  [commander] AJB: _last_manual_control_setpoint_received 51044000, elapsed_time_us 360000
INFO  [commander] AJB: _last_manual_control_setpoint_received 51536000, elapsed_time_us 112000
INFO  [commander] AJB: _last_manual_control_setpoint_received 51536000, elapsed_time_us 352000
INFO  [commander] AJB: _last_manual_control_setpoint_received 52032000, elapsed_time_us 96000
INFO  [commander] AJB: _last_manual_control_setpoint_received 52032000, elapsed_time_us 336000
INFO  [commander] AJB: _last_manual_control_setpoint_received 52524000, elapsed_time_us 84000
INFO  [commander] AJB: _last_manual_control_setpoint_received 52524000, elapsed_time_us 324000
INFO  [commander] AJB: _last_manual_control_setpoint_received 53016000, elapsed_time_us 72000
INFO  [commander] AJB: _last_manual_control_setpoint_received 53016000, elapsed_time_us 312000
INFO  [commander] AJB: _last_manual_control_setpoint_received 53508000, elapsed_time_us 60000
INFO  [commander] AJB: _last_manual_control_setpoint_received 53508000, elapsed_time_us 300000
INFO  [commander] AJB: _last_manual_control_setpoint_received 54000000, elapsed_time_us 48000
INFO  [commander] AJB: _last_manual_control_setpoint_received 54000000, elapsed_time_us 288000
INFO  [commander] AJB: _last_manual_control_setpoint_received 54348000, elapsed_time_us 180000
INFO  [commander] AJB: _last_manual_control_setpoint_received 54348000, elapsed_time_us 420000
INFO  [commander] AJB: _last_manual_control_setpoint_received 54780000, elapsed_time_us 228000
INFO  [commander] AJB: _last_manual_control_setpoint_received 54780000, elapsed_time_us 468000
INFO  [commander] AJB: _last_manual_control_setpoint_received 55272000, elapsed_time_us 216000
INFO  [commander] AJB: _last_manual_control_setpoint_received 55272000, elapsed_time_us 456000
INFO  [commander] AJB: _last_manual_control_setpoint_received 55764000, elapsed_time_us 204000
INFO  [commander] AJB: _last_manual_control_setpoint_received 55764000, elapsed_time_us 444000
INFO  [commander] AJB: _last_manual_control_setpoint_received 56256000, elapsed_time_us 192000
INFO  [commander] AJB: _last_manual_control_setpoint_received 56256000, elapsed_time_us 432000
INFO  [commander] AJB: _last_manual_control_setpoint_received 56748000, elapsed_time_us 180000
INFO  [commander] AJB: _last_manual_control_setpoint_received 56748000, elapsed_time_us 420000
INFO  [commander] AJB: _last_manual_control_setpoint_received 57228000, elapsed_time_us 180000
INFO  [commander] AJB: _last_manual_control_setpoint_received 57228000, elapsed_time_us 420000
INFO  [commander] Landing detected
INFO  [commander] DISARMED by Arm/Disarm component command
INFO  [commander] AJB: set_nav_state: main_state 5,is_armed 0, rc_signal_lost 1
INFO  [commander] AJB: _last_manual_control_setpoint_received 57708000, elapsed_time_us 180000
INFO  [commander] AJB: _last_manual_control_setpoint_received 57708000, elapsed_time_us 420000
INFO  [commander] AJB: max_loss_time_us 500000, changed mcs_timeout 0
INFO  [commander] AJB: rc_signal_found_once = true
INFO  [commander] AJB: _last_manual_control_setpoint_received 57708000, elapsed_time_us 660000
INFO  [commander] AJB: rc_signal_lost = false
INFO  [commander] AJB: _last_manual_control_setpoint_received 57708000, elapsed_time_us 900000
INFO  [commander] AJB: rc_signal_lost = false
INFO  [logger] closed logfile, bytes written: 3048252
INFO  [commander] AJB: _last_manual_control_setpoint_received 57708000, elapsed_time_us 1140000
```

Interesting how the debug shows that rc_signal_lost = false after landing but
not before takeoff.  What causes this?

Found the problem.  Changed > to < and it started working!

The successful run debug.  No failsafes!
Drone starts at 50 seconds and completes at 1:21.

```text
0:00:00 INFO: [logger] [logger] ./log/2020-08-14/15_11_46.ulg
0:00:00 INFO: [logger] Opened full log file: ./log/2020-08-14/15_11_46.ulg
0:00:00 INFO: [mavlink] MAVLink only on localhost (set param MAV_BROADCAST = 1 to enable network)
0:00:00 INFO: [px4] Startup script returned successfully
0:00:00 INFO: [micrortps_client] Trying to connect...
0:00:00 INFO: [micrortps_client] Connected to server!
0:00:00 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 0, elapsed_time_us 496000
0:00:00 INFO: [commander] AJB: max_loss_time_us 500000, changed mcs_timeout 1
0:00:00 INFO: [ecl/EKF] 564000: GPS checks passed
0:00:00 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 0, elapsed_time_us 976000
0:00:01 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 0, elapsed_time_us 1456000
0:00:01 INFO: [ekf2] Mag sensor ID changed to 197388
0:00:01 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 0, elapsed_time_us 1936000
0:00:02 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 0, elapsed_time_us 2416000
0:00:02 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 0, elapsed_time_us 2896000
0:00:03 INFO: [ecl/EKF] 2880000: reset position to last known position
0:00:03 INFO: [ecl/EKF] 2880000: reset velocity to zero
0:00:03 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 0, elapsed_time_us 3376000
0:00:03 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 0, elapsed_time_us 3856000
0:00:04 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 0, elapsed_time_us 4336000
0:00:04 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 0, elapsed_time_us 4816000
0:00:05 INFO: [ecl/EKF] 5080000: reset velocity to GPS
0:00:05 INFO: [ecl/EKF] 5080000: starting GPS fusion
0:00:05 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 0, elapsed_time_us 5296000
0:00:05 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 0, elapsed_time_us 5776000
0:00:06 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 0, elapsed_time_us 6256000
0:00:06 INFO: [commander] AJB: set_nav_state: main_state 4,is_armed 0, rc_signal_lost 1
0:00:06 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 0, elapsed_time_us 6736000
...
0:00:50 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 0, elapsed_time_us 50900000
0:00:51 INFO: [commander] AJB: rc_signal_found_once = true
0:00:51 INFO: [commander] AJB: rc_signal_lost = false
0:00:51 INFO: [commander] ARMED by Arm/Disarm component command
0:00:51 INFO: [commander] AJB: set_nav_state: main_state 4,is_armed 1, rc_signal_lost 0
0:00:51 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 51368000, elapsed_time_us 12000
0:00:51 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 51368000, elapsed_time_us 492000
0:00:52 INFO: [navigator] Using minimum takeoff altitude: 2.50 m
0:00:52 INFO: [commander] AJB: set_nav_state: main_state 10,is_armed 1, rc_signal_lost 0
0:00:52 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 52256000, elapsed_time_us 84000
0:00:52 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 52760000, elapsed_time_us 60000
0:00:53 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 53252000, elapsed_time_us 48000
0:00:53 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 53756000, elapsed_time_us 24000
0:00:53 INFO: [commander] Takeoff detected
0:00:54 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 54056000, elapsed_time_us 204000
0:00:54 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 54536000, elapsed_time_us 204000
0:00:55 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 55016000, elapsed_time_us 204000
0:00:55 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 55484000, elapsed_time_us 216000
0:00:56 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 55904000, elapsed_time_us 276000
0:00:56 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 56348000, elapsed_time_us 312000
0:00:57 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 56840000, elapsed_time_us 300000
0:00:57 INFO: [navigator] AJB: Completed takeoff.  Loitering...
0:00:57 INFO: [commander] AJB: Completed takeoff.  Loitering...
0:00:57 INFO: [commander] AJB: set_nav_state: main_state 4,is_armed 1, rc_signal_lost 0
0:00:57 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 57332000, elapsed_time_us 288000
0:00:58 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 57836000, elapsed_time_us 264000
0:00:58 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 58328000, elapsed_time_us 252000
0:00:59 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 58712000, elapsed_time_us 348000
0:00:59 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 59204000, elapsed_time_us 336000
0:01:00 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 59600000, elapsed_time_us 420000
0:01:00 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 60080000, elapsed_time_us 420000
0:01:00 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 60572000, elapsed_time_us 408000
0:01:01 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 61064000, elapsed_time_us 396000
0:01:01 INFO: [commander] Returning to launch
0:01:01 INFO: [navigator] RTL: landing at home position.
0:01:01 INFO: [navigator] RTL: climb to 499 m (10 m above destination)
0:01:01 INFO: [commander] AJB: set_nav_state: main_state 5,is_armed 1, rc_signal_lost 0
0:01:01 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 61544000, elapsed_time_us 396000
0:01:02 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 62035999, elapsed_time_us 384000
0:01:02 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 62528000, elapsed_time_us 372000
0:01:03 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 63020000, elapsed_time_us 360000
0:01:03 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 63523999, elapsed_time_us 336001
0:01:04 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 64016000, elapsed_time_us 323999
0:01:04 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 64784000, elapsed_time_us 36000
0:01:05 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 65276000, elapsed_time_us 24000
0:01:05 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 65684000, elapsed_time_us 96000
0:01:06 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 66176000, elapsed_time_us 84000
0:01:06 INFO: [navigator] RTL: return at 499 m (10 m above destination)
0:01:06 INFO: [navigator] RTL: land at destination
0:01:06 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 66680000, elapsed_time_us 60000
...
0:01:20 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 80100000, elapsed_time_us 84000
0:01:20 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 80592000, elapsed_time_us 72000
0:01:21 INFO: [commander] AJB: max_loss_time_us 500000, changed mcs_timeout 1
0:01:21 WARNING: [commander] Manual control lost
0:01:21 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 80592000, elapsed_time_us 552000
0:01:21 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 80592000, elapsed_time_us 1032000
0:01:21 INFO: [commander] Landing detected
0:01:21 WARNING: [uorb] orb_advertise_multi: failed to set queue size
0:01:22 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 80592000, elapsed_time_us 1512000
0:01:22 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 80592000, elapsed_time_us 1992000
0:01:23 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 80592000, elapsed_time_us 2472000
0:01:23 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 80592000, elapsed_time_us 2952000
0:01:23 INFO: [commander] DISARMED by Auto disarm initiated
0:01:23 INFO: [commander] AJB: set_nav_state: main_state 5,is_armed 0, rc_signal_lost 1
0:01:24 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 80592000, elapsed_time_us 3432000
0:01:24 INFO: [commander] AJB: _manual_control_setpoint_local_timestamp 80592000, elapsed_time_us 3912000
```

## Waypoints

I want to fly the drone around a course of way points that are sent by the
controlling computer in simulation.  The most difficult part of this is to
work out which uORB messages to use as

### uORB messages that might be useful

* landing_gear.msg - Change state of landing gear, up or down.
* mission.msg - This run a stored mission from dataman0 or dataman1 (normally
on an SD card).
* manual_control_setpoint.msg - Joystick messages from manual controller.
* position_setpoint.msg - This is the right one.
The documentation <https://docs.px4.io/master/en/flight_modes/offboard.html>
assumes MAVLink so might be misleading.
This looks more like it: <https://dev.px4.io/master/en/ros/offboard_control.html>
but it actaully says very little on how to use the messages.
* vehicle_local_position.msg - This could be very useful as well.

### How to use position_setpoint messages

Found this example: <https://dev.px4.io/master/en/ros/mavros_offboard.html>.
When using MAVLink, you need to send the position_setpoint messages at 2Hz or
greater. When the setpoint it being sent, then switch into offboard mode and
the UAV should move to the setpoint and loiter.  Change the value of the
setpoint and the UAV should move to the new position.

Using ORB messages, we have to do something different.  offboard_control_mode
messages have to be sent at a rate that is faster than the timeout set in the
parameter file, COM_OF_LOSS_T = 1s (default). The timestamp of this message
also needs to be fixed in the same way that was done for
manual_control_setpoint. Code for this in Commander::offboard_control_update().

The key function seems to be FlightTaskOffboard::update() where the
position_setpoint_triplet is read.  The triplet contains the previous, current
and next position_setpoints.  There is an example of useing the triplet in the
function `MavlinkReceiver::handle_message_set_position_target_local_ned()`
where only the current value is set to valid and filled in with values.
Another example is:
`MavlinkReceiver::handle_message_set_position_target_global_int()` and that
does the same thing.  Both functions also send the offboard_control_mode so
this is where the requirement to send position_setpoint messages comes from.

Offboard mode has parameters.
<https://docs.px4.io/master/en/flight_modes/offboard.html#offboard-parameters>
Links to details on this page:
<https://docs.px4.io/master/en/advanced_config/parameter_reference.html#COM_RC_OVERRIDE>

| Name | Description | Default
|---|---|---
| COM_OF_LOSS_T | Time-out to wait when offboard connection is lost before triggering offboard lost action. | 0.5 seconds
| COM_OBL_ACT | Set offboard loss failsafe mode. | 0 (land mode)
| COM_OBL_RC_ACT | Set offboard loss failsafe mode when RC is available. | 0 (position mode)
| COM_RC_OVERRIDE | RC stick overrides offboard. | 1 (enabled)

May need to changes these values (COM_OBL_ACT should be 1 (hold mode)) at some point but the defaults will do for now.

```text
# Auto test passes.
# Mission fails.
INFO  [logger] Start file log (type: full)
INFO  [logger] [logger] ./log/2020-08-28/14_42_27.ulg
INFO  [logger] closed logfile, bytes written: 1511950
INFO  [logger] Opened full log file: ./log/2020-08-28/14_42_27.ulg
INFO  [navigator] Using minimum takeoff altitude: 2.50 m
INFO  [commander] Takeoff detected
INFO  [commander] Landing detected
INFO  [commander] DISARMED by Auto disarm initiated
INFO  [logger] closed logfile, bytes written: 441970
WARN  [commander] Manual control lost
```

What appears to happen is that the drone takes off very slowly, so can
cause landing and auto disarm as it wobbles into the air.  A second run
shows the drone taking off ok but never achieves the target altitude.

```text
INFO  [logger] [logger] ./log/2020-08-28/14_46_10.ulg
INFO  [logger] Opened full log file: ./log/2020-08-28/14_46_10.ulg
INFO  [navigator] Using minimum takeoff altitude: 2.50 m
INFO  [commander] Takeoff detected
INFO  [commander] Landing detected
INFO  [commander] Takeoff detected
WARN  [commander] Manual control lost
```

The drone app was killed but no failsafe cut in so drone continued to
hover.  This is a potential problem!

Fixed a few minor things in auto_pilot.  TestMission is now arming and then
auto disarming but not taking off, even though manual control is available.
Arms, take off using position setpoint sent but no take off.

TODO: Adding debug to PX4 code to find out what is going on.
